<!DOCTYPE html>
<html lang="hi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡§∏‡§æ‡§Ç‡§µ‡§∞‡§ø‡§Ø‡§æ ‡§ú‡•Ä ‡§ú‡•ç‡§µ‡•à‡§≤‡§∞‡•ç‡§∏ - Software</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 10px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 5px;
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .nav-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        padding: 20px;
        background: #f8f9fa;
      }

      .nav-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 18px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        touch-action: manipulation;
      }

      .nav-btn:active {
        transform: scale(0.95);
      }

      .nav-btn:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .section {
        display: none;
        padding: 20px;
      }

      .section.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 16px;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        border: none;
        padding: 16px 30px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        touch-action: manipulation;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #757f9a 0%, #d7dde8 100%);
        color: #333;
      }

      .table-container {
        overflow-x: auto;
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      table th,
      table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      table th {
        background: #667eea;
        color: white;
        font-weight: bold;
      }

      table tr:hover {
        background: #f8f9fa;
      }

      .invoice-items {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        background: #f8f9fa;
      }

      .invoice-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 2fr;
        gap: 10px;
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
      }

      .invoice-item input,
      .invoice-item select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .remove-item-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .add-item-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 15px;
      }

      .summary-box {
        background: #e9ecef;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 16px;
      }

      .summary-row.total {
        font-size: 20px;
        font-weight: bold;
        color: #667eea;
        border-top: 2px solid #667eea;
        padding-top: 12px;
        margin-top: 10px;
      }

      .card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .card h3 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: bold;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .action-buttons button {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }

      .btn-edit {
        background: #ffc107;
        color: #000;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
      }

      .btn-view {
        background: #17a2b8;
        color: white;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        .print-invoice,
        .print-invoice * {
          visibility: visible;
        }
        .print-invoice {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .no-print {
          display: none !important;
          visibility: hidden !important;
        }
      }

      .print-invoice {
        padding: 30px;
        max-width: 800px;
        margin: 0 auto;
      }

      .print-header {
        text-align: center;
        border-bottom: 3px solid #000;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .print-header h1 {
        font-size: 32px;
        color: #667eea;
        margin-bottom: 5px;
      }

      .print-header p {
        font-size: 14px;
        margin: 3px 0;
      }

      .invoice-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .print-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      .print-table th,
      .print-table td {
        border: 1px solid #000;
        padding: 10px;
        text-align: left;
      }

      .print-table th {
        background: #f0f0f0;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: 24px;
        height: 24px;
        cursor: pointer;
      }

      .checkbox-group label {
        margin: 0;
        cursor: pointer;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }

        .invoice-item {
          grid-template-columns: 1fr;
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-card h4 {
        font-size: 14px;
        margin-bottom: 10px;
        opacity: 0.9;
      }

      .stat-card p {
        font-size: 24px;
        font-weight: bold;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
        overflow-y: auto;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background-color: #fefefe;
        margin: 20px auto;
        padding: 0;
        border: none;
        border-radius: 15px;
        width: 95%;
        max-width: 500px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 18px;
      }

      .close-modal {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        width: 35px;
        height: 35px;
        line-height: 35px;
        text-align: center;
        border-radius: 50%;
      }

      .close-modal:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-body {
        padding: 15px;
        max-height: 70vh;
        overflow-y: auto;
      }

      .modal-footer {
        padding: 15px;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .modal-footer button {
        flex: 1;
        max-width: 150px;
      }

      .modal-input {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 18px;
        margin-top: 10px;
        box-sizing: border-box;
      }

      .modal-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .info-box {
        background: #e7f3ff;
        border-left: 4px solid #2196f3;
        padding: 12px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .info-box h4 {
        font-size: 16px;
      }

      .info-box p {
        font-size: 14px;
      }

      .warning-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .warning-box h4 {
        font-size: 16px;
      }

      .success-box {
        background: #d4edda;
        border-left: 4px solid #28a745;
        padding: 12px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .success-box h4 {
        font-size: 16px;
      }

      .stat-grid-modal {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin: 15px 0;
      }

      @media (min-width: 400px) {
        .stat-grid-modal {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      .stat-box {
        text-align: center;
        padding: 15px 10px;
        border-radius: 8px;
      }

      .stat-box p:first-child {
        font-size: 11px;
        margin: 0;
      }

      .stat-box p:last-child {
        font-size: 18px;
        font-weight: bold;
        margin: 5px 0 0 0;
      }

      @media (max-width: 768px) {
        .modal-content {
          margin: 10px;
          width: calc(100% - 20px);
        }

        .modal-header h3 {
          font-size: 16px;
        }

        .modal-body {
          padding: 12px;
        }

        .info-box,
        .warning-box,
        .success-box {
          padding: 10px;
          font-size: 13px;
        }
      }

      /* Stone & Extra Charges Panel */
      .stone-panel {
        background: #fff;
        border: 1px dashed #cbd5e0;
        border-radius: 8px;
        padding: 10px;
        margin-top: 8px;
      }
      .stone-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
      }
      .extra-charge-row {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
      }
      .extra-charge-btn {
        margin-top: 6px;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        background: #757f9a;
        color: #fff;
        cursor: pointer;
      }
      .remove-extra-btn {
        border: none;
        background: #dc3545;
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
      }

      @media (max-width: 480px) {
        .invoice-items {
          padding: 8px;
        }
        .invoice-item {
          padding: 8px;
          gap: 8px;
        }
        .stone-panel {
          padding: 8px;
          margin-top: 8px;
        }
        .stone-row {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .extra-charge-row {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .stone-panel input,
        .stone-panel select {
          font-size: 16px;
          padding: 12px;
          min-height: 48px;
          width: 100%;
          box-sizing: border-box;
        }
        .extra-charge-btn {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          box-sizing: border-box;
        }
        .invoice-item input,
        .invoice-item select {
          padding: 12px;
          font-size: 16px;
          min-height: 48px;
          width: 100%;
          box-sizing: border-box;
        }
        .remove-item-btn {
          width: 100%;
          padding: 12px;
          font-size: 16px;
          margin-top: 8px;
        }
        .remove-extra-btn {
          width: 100%;
          padding: 10px;
          font-size: 14px;
          margin-top: 5px;
        }

        /* Print buttons mobile responsive */
        .no-print {
          flex-direction: column !important;
          padding: 0 10px;
        }
        .no-print button {
          width: 100% !important;
          margin-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>‡§∏‡§æ‡§Ç‡§µ‡§∞‡§ø‡§Ø‡§æ ‡§ú‡•Ä ‡§ú‡•ç‡§µ‡•à‡§≤‡§∞‡•ç‡§∏</h1>
        <p>Ugam Raj Soni | üìû 9351896678</p>
        <p>36, ‡§∞‡•Å‡§à ‡§ï‡§ü‡§≤‡§æ, ‡§®‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§¢‡§æ‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§π‡§∞</p>
      </div>

      <div class="nav-buttons">
        <button class="nav-btn" onclick="showSection('metalRates')">
          ü™ô ‡§ß‡§æ‡§§‡•Å ‡§¶‡§∞
        </button>
        <button class="nav-btn" onclick="showSection('inventory')">
          üì¶ ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä
        </button>
        <button class="nav-btn" onclick="showSection('invoice')">
          üìÑ ‡§¨‡§ø‡§≤ ‡§¨‡§®‡§æ‡§è‡§Ç
        </button>
        <button class="nav-btn" onclick="showSection('customers')">
          üë• ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï
        </button>
        <button class="nav-btn" onclick="showSection('interest')">
          üí∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞
        </button>
        <button class="nav-btn" onclick="showSection('accounting')">
          üìä ‡§π‡§ø‡§∏‡§æ‡§¨-‡§ï‡§ø‡§§‡§æ‡§¨
        </button>
        <button class="nav-btn" onclick="showSection('backup')">
          üíæ ‡§¨‡•à‡§ï‡§Ö‡§™
        </button>
      </div>

      <!-- Metal Rates Section -->
      <div id="metalRates" class="section active">
        <h2>‡§ß‡§æ‡§§‡•Å ‡§¶‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (Metal Rates)</h2>
        <div class="card">
          <div class="form-group">
            <label>10 ‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡•ã‡§®‡§æ (Gold) - ‡§¶‡§∞ (‚Çπ)</label>
            <input
              type="number"
              id="goldRate"
              placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: 75000"
              value="75000"
            />
          </div>
          <div class="form-group">
            <label>10 ‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§ö‡§æ‡§Ç‡§¶‡•Ä (Silver) - ‡§¶‡§∞ (‚Çπ)</label>
            <input
              type="number"
              id="silverRate"
              placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: 8500"
              value="8500"
            />
          </div>
          <button class="btn" onclick="saveMetalRates()">‡§¶‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
        <div class="summary-box">
          <h3>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¶‡§∞‡•á‡§Ç (Current Rates)</h3>
          <div class="summary-row">
            <span>‡§∏‡•ã‡§®‡§æ (10g):</span>
            <span>‚Çπ <span id="displayGoldRate">75000</span></span>
          </div>
          <div class="summary-row">
            <span>‡§ö‡§æ‡§Ç‡§¶‡•Ä (10g):</span>
            <span>‚Çπ <span id="displaySilverRate">8500</span></span>
          </div>
        </div>
      </div>

      <!-- Inventory Section -->
      <div id="inventory" class="section">
        <h2>‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (Inventory Management)</h2>

        <div class="card">
          <h3>‡§®‡§Ø‡§æ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (Purchase Entry)</h3>
          <div class="form-group">
            <label>‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ (Item Name) *</label>
            <input
              type="text"
              id="itemName"
              placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: Ring, Payal"
            />
          </div>
          <div class="form-group">
            <label>‡§ß‡§æ‡§§‡•Å (Metal Type) *</label>
            <select id="itemMetalType">
              <option value="">‡§ö‡•Å‡§®‡•á‡§Ç (Select)</option>
              <option value="gold">‡§∏‡•ã‡§®‡§æ (Gold)</option>
              <option value="silver">‡§ö‡§æ‡§Ç‡§¶‡•Ä (Silver)</option>
            </select>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>‡§ï‡•Å‡§≤ ‡§µ‡§ú‡§® (‡§ó‡•ç‡§∞‡§æ‡§Æ) *</label>
              <input type="number" id="itemWeight" placeholder="1000" />
            </div>
            <div class="form-group">
              <label>‡§ï‡•Å‡§≤ ‡§™‡•Ä‡§∏ (Total Pcs) *</label>
              <input type="number" id="itemPcs" placeholder="300" />
            </div>
            <div class="form-group">
              <label>‡§ü‡§Ç‡§ö % (Purity)</label>
              <input type="number" id="itemTunch" placeholder="60" value="0" />
            </div>
            <div class="form-group">
              <label>‡§µ‡•á‡§∏‡•ç‡§ü‡•á‡§ú % (Wastage)</label>
              <input
                type="number"
                id="itemWastage"
                placeholder="20"
                value="0"
              />
            </div>
          </div>
          <div class="grid-2">
            <div class="form-group">
              <label>‡§ï‡§ø‡§∏‡§∏‡•á ‡§ñ‡§∞‡•Ä‡§¶‡§æ (Supplier - Optional)</label>
              <input
                type="text"
                id="itemSupplier"
                placeholder="‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ"
              />
            </div>
            <div class="form-group">
              <label>‡§ñ‡§∞‡•Ä‡§¶ ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ (Purchase Date - Optional)</label>
              <input type="date" id="itemPurchaseDate" />
            </div>
            <div class="form-group">
              <label>‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Purchase Price - Optional)</label>
              <input type="number" id="itemPurchasePrice" placeholder="0" />
            </div>
          </div>
          <button class="btn" onclick="addInventoryItem()">‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
        </div>

        <div class="table-container">
          <table id="inventoryTable">
            <thead>
              <tr>
                <th>‡§Ü‡§á‡§ü‡§Æ</th>
                <th>‡§ß‡§æ‡§§‡•Å</th>
                <th>‡§µ‡§ú‡§® (g)</th>
                <th>‡§™‡•Ä‡§∏</th>
                <th>‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞</th>
                <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
              </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Invoice Section -->
      <div id="invoice" class="section">
        <h2>‡§®‡§Ø‡§æ ‡§¨‡§ø‡§≤ ‡§¨‡§®‡§æ‡§è‡§Ç (Create Invoice)</h2>

        <div class="card">
          <h3>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä (Customer Information)</h3>
          <div class="form-group">
            <label>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ (Customer Name)</label>
            <input
              type="text"
              id="customerName"
              list="customerNameList"
              placeholder="‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç"
              oninput="fillPhoneFromName(this.value)"
            />
            <datalist id="customerNameList"></datalist>
          </div>
          <div class="form-group">
            <label>‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (Phone Number)</label>
            <input
              type="tel"
              id="customerPhone"
              list="customerPhoneList"
              placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞"
              oninput="searchCustomer(this.value)"
            />
            <datalist id="customerPhoneList"></datalist>
          </div>
        </div>

        <div class="card">
          <h3>‡§¨‡§ø‡§≤ ‡§Ü‡§á‡§ü‡§Æ (Invoice Items)</h3>
          <button class="add-item-btn" onclick="addInvoiceItem()">
            + ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§∏‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
          </button>
          <button
            class="add-item-btn"
            style="background: #007bff"
            onclick="addManualInvoiceItem()"
          >
            + ‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
          </button>
          <div id="invoiceItems"></div>
        </div>

        <div class="card">
          <h3>‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§∏‡•ã‡§®‡§æ/‡§ö‡§æ‡§Ç‡§¶‡•Ä ‡§ñ‡§∞‡•Ä‡§¶ (Old Jewellery Purchase - Optional)</h3>
          <div class="checkbox-group">
            <input
              type="checkbox"
              id="hasOldJewellery"
              onchange="toggleOldJewellery()"
            />
            <label for="hasOldJewellery">‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§∏‡•ã‡§®‡§æ/‡§ö‡§æ‡§Ç‡§¶‡•Ä ‡§π‡•à?</label>
          </div>
          <div id="oldJewellerySection" style="display: none">
            <!-- Calculation Fields -->
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="margin-bottom: 12px; color: #2c5aa0;">‡§ó‡§£‡§®‡§æ (Calculation)</h4>
              
              <div class="form-group">
                <label>‡§µ‡§ú‡§® (Weight) - ‡§ó‡•ç‡§∞‡§æ‡§Æ</label>
                <input type="number" id="oldMetalWeight" placeholder="0" step="0.001" oninput="calculateOldMetalAmount()" />
              </div>
              
              <div class="form-group">
                <label>‡§ü‡§ö (Tounch)</label>
                <input type="number" id="oldMetalTounch" placeholder="0" step="0.01" oninput="calculateOldMetalAmount()" />
              </div>
              
              <div class="form-group">
                <label>‡§ñ‡§∞‡•Ä‡§¶ ‡§≠‡§æ‡§µ (10g) - ‚Çπ</label>
                <input type="number" id="oldMetalRate10g" placeholder="0" step="0.01" oninput="calculateOldMetalAmount()" />
              </div>
              
              <div class="form-group">
                <label>‡§™‡§∞‡§ø‡§£‡§æ‡§Æ (Result) - ‚Çπ</label>
                <div style="display: flex; gap: 8px;">
                  <input type="number" id="oldMetalCalculatedAmount" placeholder="0" readonly style="background: #f8f9fa; flex: 1;" />
                  <button type="button" onclick="copyCalculatedAmount()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; min-width: 100px;">
                    üìã Copy
                  </button>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label>
              <input type="number" id="oldJewelleryAmount" placeholder="0" />
            </div>
            <div class="form-group">
              <label>‡§µ‡§ø‡§µ‡§∞‡§£ (Description - Optional)</label>
              <textarea
                id="oldJewelleryDesc"
                rows="2"
                placeholder="‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§∏‡•ã‡§®‡•á ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä..."
              ></textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Payment)</h3>
          <div class="form-group">
            <label>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Payment Type)</label>
            <select id="paymentType">
              <option value="full">‡§™‡•Ç‡§∞‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Full Payment)</option>
              <option value="partial">‡§Ü‡§Ç‡§∂‡§ø‡§ï ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Partial Payment)</option>
              <option value="credit">‡§â‡§ß‡§æ‡§∞ (Credit)</option>
              <option value="advance">üéÅ ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ (Advance)</option>
            </select>
          </div>
          <div class="form-group">
            <label>‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∞‡§æ‡§∂‡§ø (Amount Received) ‚Çπ</label>
            <input type="number" id="amountReceived" placeholder="0" />
          </div>
        </div>

        <div class="summary-box">
          <h3>‡§¨‡§ø‡§≤ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Invoice Summary)</h3>
          <div
            class="summary-row"
            id="previousBalanceRow"
            style="
              display: none;
              background: #fff3cd;
              padding: 10px;
              margin-bottom: 10px;
              border-radius: 5px;
            "
          >
            <span style="color: #856404; font-weight: bold"
              >‚ö†Ô∏è ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ:</span
            >
            <span style="color: #856404; font-weight: bold"
              >‚Çπ <span id="previousBalance">0</span></span
            >
          </div>
          <div class="summary-row">
            <span>‡§ï‡•Å‡§≤ ‡§ß‡§æ‡§§‡•Å ‡§Æ‡•Ç‡§≤‡•ç‡§Ø:</span>
            <span>‚Çπ <span id="totalMetalValue">0</span></span>
          </div>
          <div class="summary-row">
            <span>‡§ï‡•Å‡§≤ ‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä:</span>
            <span>‚Çπ <span id="totalLabour">0</span></span>
          </div>
          <div class="summary-row">
            <span>‡§â‡§™-‡§Ø‡•ã‡§ó:</span>
            <span>‚Çπ <span id="subtotal">0</span></span>
          </div>
          <div class="summary-row">
            <span>‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å (-):</span>
            <span>‚Çπ <span id="oldMetalDeduction">0</span></span>
          </div>
          <div class="summary-row total">
            <span>‡§á‡§∏ ‡§¨‡§ø‡§≤ ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø:</span>
            <span>‚Çπ <span id="grandTotal">0</span></span>
          </div>
          <div
            class="summary-row total"
            style="
              background: #fff3cd;
              padding: 10px;
              border-radius: 5px;
              margin-top: 10px;
            "
          >
            <span style="color: #856404">‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ (‡§™‡•Å‡§∞‡§æ‡§®‡§æ + ‡§®‡§Ø‡§æ):</span>
            <span style="color: #856404"
              >‚Çπ <span id="totalWithPrevious">0</span></span
            >
          </div>
          <div class="summary-row">
            <span>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§õ‡•Ç‡§ü/‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü (-):</span>
            <span
              >‚Çπ
              <input
                type="number"
                id="finalDiscountInput"
                value="0"
                step="0.01"
                oninput="updateInvoiceSummary()"
                onchange="updateInvoiceSummary()"
                style="
                  width: 140px;
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                "
            /></span>
          </div>
          <div
            class="summary-row total"
            style="
              background: #e7f3ff;
              padding: 10px;
              border-radius: 5px;
              margin-top: 10px;
            "
          >
            <span>‡§õ‡•Ç‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¶‡•á‡§Ø:</span>
            <span>‚Çπ <span id="discountedTotal">0</span></span>
          </div>

          <div class="summary-row">
            <span>‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∞‡§æ‡§∂‡§ø (‡§®‡§ï‡§¶ + ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§∏‡•ã‡§®‡§æ):</span>
            <span>‚Çπ <span id="receivedAmount">0</span></span>
          </div>
          <div class="summary-row total" style="color: #dc3545">
            <span>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡§æ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø:</span>
            <span>‚Çπ <span id="balanceDue">0</span></span>
          </div>
        </div>

        <button class="btn" onclick="generateInvoice()">
          ‡§¨‡§ø‡§≤ ‡§¨‡§®‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
        </button>
      </div>

      <!-- Customers Section -->
      <div id="customers" class="section">
        <h2>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§≤‡•á‡§ú‡§∞ (Customer Ledger)</h2>

        <div class="card" id="customerDetailView" style="display: none">
          <h3>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</h3>
          <button class="btn btn-secondary" onclick="closeCustomerDetail()">
            ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç
          </button>
          <div id="customerDetailContent"></div>
        </div>

        <div id="customerListView">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>‡§®‡§æ‡§Æ</th>
                  <th>‡§´‡•ã‡§®</th>
                  <th>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•Ä‡§¶</th>
                  <th>‡§¨‡§æ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø</th>
                  <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
                </tr>
              </thead>
              <tbody id="customersBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Interest Business Section -->
      <div id="interest" class="section">
        <h2>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ (Interest Business)</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <h4>‡§ï‡•Å‡§≤ ‡§â‡§ß‡§æ‡§∞ ‡§¶‡•Ä ‡§ó‡§à ‡§∞‡§æ‡§∂‡§ø</h4>
            <p>‚Çπ <span id="totalLent">0</span></p>
          </div>
          <div class="stat-card">
            <h4>‡§ï‡•Å‡§≤ ‡§≤‡•Ä ‡§ó‡§à ‡§∞‡§æ‡§∂‡§ø</h4>
            <p>‚Çπ <span id="totalBorrowed">0</span></p>
          </div>
          <div class="stat-card">
            <h4>‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡§æ ‡§≤‡§æ‡§≠</h4>
            <p>‚Çπ <span id="monthlyProfit">0</span></p>
          </div>
        </div>

        <div class="card">
          <h3>‡§®‡§Ø‡§æ ‡§≤‡•á‡§®-‡§¶‡•á‡§® (New Transaction)</h3>
          <div class="form-group">
            <label>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Type)</label>
            <select id="transactionType">
              <option value="lent">‡§â‡§ß‡§æ‡§∞ ‡§¶‡§ø‡§Ø‡§æ (Money Lent to Customer)</option>
              <option value="borrowed">
                ‡§â‡§ß‡§æ‡§∞ ‡§≤‡§ø‡§Ø‡§æ (Money Borrowed from Relative)
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>‡§®‡§æ‡§Æ (Name)</label>
            <input
              type="text"
              id="transactionName"
              placeholder="‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ"
            />
          </div>
          <div class="form-group">
            <label>‡§∞‡§æ‡§∂‡§ø (Amount) ‚Çπ</label>
            <input type="number" id="transactionAmount" placeholder="0" />
          </div>
          <div class="form-group">
            <label>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞ (%) ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π</label>
            <input
              type="number"
              id="interestRate"
              placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: 3 ‡§Ø‡§æ 1.25"
              step="0.01"
            />
          </div>
          <div class="form-group">
            <label>‡§§‡§æ‡§∞‡•Ä‡§ñ (Date)</label>
            <input type="date" id="transactionDate" />
          </div>
          <button class="btn" onclick="addInterestTransaction()">
            ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
          </button>
        </div>

        <h3>‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§≤‡•á‡§®-‡§¶‡•á‡§® (Active Transactions)</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡§®‡§æ‡§Æ</th>
                <th>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
                <th>‡§∞‡§æ‡§∂‡§ø</th>
                <th>‡§¨‡•ç‡§Ø‡§æ‡§ú %</th>
                <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                <th>‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú</th>
                <th>‡§ú‡§Æ‡§æ ‡§¨‡•ç‡§Ø‡§æ‡§ú</th>
                <th>‡§¨‡§æ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú</th>
                <th>‡§ö‡•Å‡§ï‡§æ‡§Ø‡§æ ‡§Æ‡•Ç‡§≤‡§ß‡§®</th>
                <th>‡§¨‡§æ‡§ï‡•Ä ‡§Æ‡•Ç‡§≤‡§ß‡§®</th>
                <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
              </tr>
            </thead>
            <tbody id="interestBody"></tbody>
          </table>
        </div>

        <h3 style="margin-top: 30px">‡§¨‡§Ç‡§¶ ‡§π‡•Å‡§è ‡§≤‡•á‡§®-‡§¶‡•á‡§® (Closed Transactions)</h3>
        <button
          class="btn btn-secondary"
          onclick="toggleClosedTransactions()"
          style="margin-bottom: 15px"
        >
          ‡§¶‡•á‡§ñ‡•á‡§Ç / ‡§õ‡•Å‡§™‡§æ‡§è‡§Ç
        </button>
        <div id="closedTransactionsView" style="display: none">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>‡§®‡§æ‡§Æ</th>
                  <th>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
                  <th>‡§∞‡§æ‡§∂‡§ø</th>
                  <th>‡§¨‡•ç‡§Ø‡§æ‡§ú %</th>
                  <th>‡§∂‡•Å‡§∞‡•Ç</th>
                  <th>‡§¨‡§Ç‡§¶</th>
                  <th>‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú</th>
                  <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
                </tr>
              </thead>
              <tbody id="closedInterestBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Accounting Section -->
      <div id="accounting" class="section">
        <h2>‡§π‡§ø‡§∏‡§æ‡§¨-‡§ï‡§ø‡§§‡§æ‡§¨ (Profit & Loss)</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <h4>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä</h4>
            <p>‚Çπ <span id="totalSales">0</span></p>
          </div>
          <div class="stat-card">
            <h4>‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§</h4>
            <p>‚Çπ <span id="totalReceived">0</span></p>
          </div>
          <div class="stat-card">
            <h4>‡§¨‡§æ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø</h4>
            <p>‚Çπ <span id="totalPending">0</span></p>
          </div>
        </div>

        <div class="card">
          <h3>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (Sales Report)</h3>
          <div class="grid-2">
            <div class="form-group">
              <label>‡§∏‡•á (From)</label>
              <input type="date" id="reportFromDate" />
            </div>
            <div class="form-group">
              <label>‡§§‡§ï (To)</label>
              <input type="date" id="reportToDate" />
            </div>
          </div>
          <button class="btn" onclick="generateReport()">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
        </div>

        <div id="reportResult"></div>
      </div>

      <!-- Backup Section -->
      <div id="backup" class="section">
        <h2>‡§¨‡•à‡§ï‡§Ö‡§™ ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ (Backup & Data)</h2>

        <div class="card">
          <h3>‡§Ü‡§ú ‡§ï‡§æ ‡§¨‡•à‡§ï‡§Ö‡§™</h3>
          <p>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡•à‡§ï‡§Ö‡§™: <strong id="lastBackup">‡§ï‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç</strong></p>
          <button class="btn" onclick="createBackup()">‡§Ö‡§≠‡•Ä ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§¨‡§®‡§æ‡§è‡§Ç</button>
          <button class="btn btn-secondary" onclick="downloadBackup()">
            ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
          </button>
        </div>

        <div class="card">
          <h3>‡§°‡•á‡§ü‡§æ ‡§™‡•Å‡§®‡§∞‡•ç‡§∏‡•ç‡§•‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç (Restore Data)</h3>
          <input
            type="file"
            id="restoreFile"
            accept=".json"
            style="display: none"
            onchange="restoreBackup(this)"
          />
          <button
            class="btn btn-secondary"
            onclick="document.getElementById('restoreFile').click()"
          >
            ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç
          </button>
        </div>

        <div class="card">
          <h3>‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Ç (Delete All Data)</h3>
          <button class="btn btn-danger" onclick="clearAllData()">
            ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Ç
          </button>
        </div>
      </div>
    </div>

    <!-- Print Invoice Template (Hidden) -->
    <div id="printInvoice" class="print-invoice" style="display: none"></div>

    <!-- Modal Dialogs -->
    <!-- Interest Payment Modal -->
    <div id="payInterestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üí∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</h3>
          <button class="close-modal" onclick="closeModal('payInterestModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div id="payInterestContent"></div>
          <label
            id="paymentInputLabel"
            style="font-weight: bold; margin-top: 15px; display: block"
            >‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label
          >
          <input
            type="number"
            id="payInterestAmount"
            class="modal-input"
            placeholder="‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç"
            min="0"
            step="0.01"
          />
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('payInterestModal')"
          >
            ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
          </button>
          <button class="btn" onclick="confirmPayInterest()">‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
      </div>
    </div>

    <!-- Interest History Modal -->
    <div id="interestHistoryModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üìä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h3>
          <button
            class="close-modal"
            onclick="closeModal('interestHistoryModal')"
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="interestHistoryContent"></div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('interestHistoryModal')"
          >
            ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
          </button>
        </div>
      </div>
    </div>

    <!-- Close Transaction Modal -->
    <div id="closeTransactionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚ö†Ô∏è ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</h3>
          <button
            class="close-modal"
            onclick="closeModal('closeTransactionModal')"
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="closeTransactionContent"></div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('closeTransactionModal')"
          >
            ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
          </button>
          <button class="btn btn-danger" onclick="confirmCloseTransaction()">
            ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize data structure
      let appData = {
        metalRates: { gold: 75000, silver: 8500 },
        inventory: [],
        customers: {},
        invoices: [],
        interestTransactions: [],
        lastBackup: null,
      };

      // Load data from localStorage
      function loadData() {
        try {
          const saved = localStorage.getItem("jewelleryData");
          if (saved) {
            appData = JSON.parse(saved);
            updateMetalRatesDisplay();
            renderInventory();
            renderCustomers();
            populateCustomerDatalist();
            renderInterestTransactions();
            updateAccountingStats();
            if (appData.lastBackup) {
              document.getElementById("lastBackup").textContent = new Date(
                appData.lastBackup
              ).toLocaleString("hi-IN");
            }
          }
          autoBackup();
        } catch (error) {
          console.error("Error loading data:", error);
          alert("Data load error: " + error.message);
        }
      }

      // Save data to localStorage
      function saveData() {
        localStorage.setItem("jewelleryData", JSON.stringify(appData));
      }

      // Auto backup daily
      function autoBackup() {
        const lastBackup = appData.lastBackup;
        const today = new Date().toDateString();

        if (!lastBackup || new Date(lastBackup).toDateString() !== today) {
          createBackup();
        }

        // Schedule next check
        setTimeout(autoBackup, 3600000); // Check every hour
      }

      // Navigation
      function showSection(sectionId) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");
      }

      // Metal Rates
      function saveMetalRates() {
        const gold = parseFloat(document.getElementById("goldRate").value) || 0;
        const silver =
          parseFloat(document.getElementById("silverRate").value) || 0;

        appData.metalRates.gold = gold;
        appData.metalRates.silver = silver;

        saveData();
        updateMetalRatesDisplay();
        alert("‡§ß‡§æ‡§§‡•Å ‡§¶‡§∞‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡§Ç! (Rates saved!)");
      }

      function updateMetalRatesDisplay() {
        document.getElementById("goldRate").value = appData.metalRates.gold;
        document.getElementById("silverRate").value = appData.metalRates.silver;
        document.getElementById("displayGoldRate").textContent =
          appData.metalRates.gold.toFixed(0);
        document.getElementById("displaySilverRate").textContent =
          appData.metalRates.silver.toFixed(0);
      }

      // Inventory Management
      function addInventoryItem() {
        const name = document.getElementById("itemName").value.trim();
        const metalType = document.getElementById("itemMetalType").value;
        const weight =
          parseFloat(document.getElementById("itemWeight").value) || 0;
        const pcs = parseInt(document.getElementById("itemPcs").value) || 0;
        const tunch =
          parseFloat(document.getElementById("itemTunch").value) || 0;
        const wastage =
          parseFloat(document.getElementById("itemWastage").value) || 0;
        const supplier = document.getElementById("itemSupplier").value.trim();
        const purchaseDate = document.getElementById("itemPurchaseDate").value;
        const purchasePrice =
          parseFloat(document.getElementById("itemPurchasePrice").value) || 0;

        if (!name || !metalType || weight <= 0 || pcs <= 0) {
          alert(
            "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç! (‡§®‡§æ‡§Æ, ‡§ß‡§æ‡§§‡•Å, ‡§µ‡§ú‡§®, ‡§™‡•Ä‡§∏)\n(Please fill required fields!)"
          );
          return;
        }

        appData.inventory.push({
          id: Date.now(),
          name,
          metalType,
          weight,
          pcs,
          tunch,
          wastage,
          supplier: supplier || "N/A",
          purchaseDate: purchaseDate || "N/A",
          purchasePrice,
        });

        saveData();
        renderInventory();

        // Clear form
        document.getElementById("itemName").value = "";
        document.getElementById("itemMetalType").value = "";
        document.getElementById("itemWeight").value = "";
        document.getElementById("itemPcs").value = "";
        document.getElementById("itemTunch").value = "0";
        document.getElementById("itemWastage").value = "0";
        document.getElementById("itemSupplier").value = "";
        document.getElementById("itemPurchaseDate").value = "";
        document.getElementById("itemPurchasePrice").value = "";

        alert("‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ! (Item added!)");
      }

      function renderInventory() {
        const tbody = document.getElementById("inventoryBody");
        tbody.innerHTML = "";

        appData.inventory.forEach((item) => {
          const row = tbody.insertRow();
          const metalText = item.metalType === "gold" ? "ü™ô ‡§∏‡•ã‡§®‡§æ" : "‚ö™ ‡§ö‡§æ‡§Ç‡§¶‡•Ä";
          const dateText =
            item.purchaseDate !== "N/A"
              ? new Date(item.purchaseDate).toLocaleDateString("hi-IN")
              : "N/A";

          row.innerHTML = `
                    <td><strong>${item.name}</strong><br><small>‡§ü‡§Ç‡§ö: ${item.tunch}% | ‡§µ‡•á‡§∏‡•ç‡§ü‡•á‡§ú: ${item.wastage}%</small></td>
                    <td>${metalText}</td>
                    <td>${item.weight}g</td>
                    <td>${item.pcs}</td>
                    <td>${item.supplier}</td>
                    <td>${dateText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-view" onclick="viewInventoryItem(${item.id})">‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                            <button class="btn-delete" onclick="deleteInventoryItem(${item.id})">‡§Æ‡§ø‡§ü‡§æ‡§è‡§Ç</button>
                        </div>
                    </td>
                `;
        });
      }

      function viewInventoryItem(id) {
        const item = appData.inventory.find((i) => i.id === id);
        if (item) {
          const metalText =
            item.metalType === "gold" ? "‡§∏‡•ã‡§®‡§æ (Gold)" : "‡§ö‡§æ‡§Ç‡§¶‡•Ä (Silver)";
          const dateText =
            item.purchaseDate !== "N/A"
              ? new Date(item.purchaseDate).toLocaleDateString("hi-IN")
              : "N/A";
          alert(
            `‡§Ü‡§á‡§ü‡§Æ: ${item.name}\n‡§ß‡§æ‡§§‡•Å: ${metalText}\n‡§µ‡§ú‡§®: ${item.weight}g\n‡§™‡•Ä‡§∏: ${item.pcs}\n‡§ü‡§Ç‡§ö: ${item.tunch}%\n‡§µ‡•á‡§∏‡•ç‡§ü‡•á‡§ú: ${item.wastage}%\n‡§∏‡§™‡•ç‡§≤‡§æ‡§Ø‡§∞: ${item.supplier}\n‡§§‡§æ‡§∞‡•Ä‡§ñ: ${dateText}\n‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø: ‚Çπ${item.purchasePrice}`
          );
        }
      }

      function deleteInventoryItem(id) {
        if (confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§Ü‡§á‡§ü‡§Æ ‡§ï‡•ã ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
          appData.inventory = appData.inventory.filter(
            (item) => item.id !== id
          );
          saveData();
          renderInventory();
        }
      }

      // Invoice Management
      let invoiceItemCounter = 0;

      function addInvoiceItem() {
        if (appData.inventory.length === 0) {
          alert(
            "‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§á‡§®‡•ç‡§µ‡•á‡§Ç‡§ü‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§Ø‡§æ ‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Ü‡§á‡§ü‡§Æ ‡§¨‡§®‡§æ‡§è‡§Ç‡•§\n(Inventory is empty! Please add inventory first or use manual item.)"
          );
          return;
        }

        const container = document.getElementById("invoiceItems");
        const itemDiv = document.createElement("div");
        itemDiv.className = "invoice-item";
        itemDiv.id = `item-${invoiceItemCounter}`;

        itemDiv.innerHTML = `
                <select onchange="updateInvoiceSummary()">
                    <option value="">‡§Ü‡§á‡§ü‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                    ${appData.inventory
                      .map((item) => {
                        const metalIcon =
                          item.metalType === "gold" ? "ü™ô" : "‚ö™";
                        return `<option value="${item.id}" data-metal="${item.metalType}">${metalIcon} ${item.name}</option>`;

                        // --- Stone/Extra Charges Panel (hidden by default) ---
                        const stonePanel = document.createElement("div");
                        stonePanel.className = "stone-panel";
                        stonePanel.style.display = "none";
                        stonePanel.innerHTML = `
        <div class="stone-row">
            <input type="number" class="stone-weight-input" placeholder="‡§∏‡•ç‡§ü‡•ã‡§® ‡§µ‡§ú‡§® (‡§ó‡•ç‡§∞‡§æ‡§Æ)" step="0.01" oninput="updateInvoiceSummary()">
            <input type="number" class="stone-charges-input" placeholder="‡§∏‡•ç‡§ü‡•ã‡§® ‡§ö‡§æ‡§∞‡•ç‡§ú (‚Çπ)" step="0.01" oninput="updateInvoiceSummary()">
        </div>
        <div class="extra-charges-list"></div>
        <button type="button" class="extra-charge-btn" onclick="addExtraCharge(this)">+ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    `;
                        itemDiv.appendChild(stonePanel);

                        // Show stone panel only if selected inventory metal is gold
                        const invSelect = itemDiv.querySelector("select");
                        function toggleStonePanelInv() {
                          const opt = invSelect
                            ? invSelect.options[invSelect.selectedIndex]
                            : null;
                          const metal = opt
                            ? opt.getAttribute("data-metal")
                            : "";
                          if (metal === "gold") {
                            stonePanel.style.display = "block";
                          } else {
                            stonePanel.style.display = "none";
                            const sw = itemDiv.querySelector(
                              ".stone-weight-input"
                            );
                            if (sw) sw.value = "";
                            const sc = itemDiv.querySelector(
                              ".stone-charges-input"
                            );
                            if (sc) sc.value = "";
                            const list = itemDiv.querySelector(
                              ".extra-charges-list"
                            );
                            if (list) list.innerHTML = "";
                          }
                          updateInvoiceSummary();
                        }
                        if (invSelect) {
                          invSelect.addEventListener(
                            "change",
                            toggleStonePanelInv
                          );
                        }
                      })
                      .join("")}
                </select>
                <input type="number" placeholder="‡§µ‡§ú‡§® (g)" oninput="updateInvoiceSummary()" min="0" step="0.01">
                <input type="number" placeholder="‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ" oninput="updateInvoiceSummary()" min="1" value="1">
                <div>
                    <select onchange="updateInvoiceSummary()">
                        <option value="pg">‡§™‡•ç‡§∞‡§§‡§ø ‡§ó‡•ç‡§∞‡§æ‡§Æ (Per Gram)</option>
                        <option value="ppc">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•Ä‡§∏ (Per Piece)</option>
                        <option value="pkg">‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã (Per KG)</option>
                        <option value="fixed">‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° (Fixed)</option>
                        <option value="percent">‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ (Percentage)</option>
                    </select>
                    <input type="number" placeholder="‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä" oninput="updateInvoiceSummary()" min="0">
                </div>
                <button class="remove-item-btn" onclick="removeInvoiceItem(${invoiceItemCounter})">‡§π‡§ü‡§æ‡§è‡§Ç</button>
            `;

        container.appendChild(itemDiv);
        invoiceItemCounter++;
      }

      function addManualInvoiceItem() {
        const container = document.getElementById("invoiceItems");
        const itemDiv = document.createElement("div");
        itemDiv.className = "invoice-item";
        itemDiv.id = `item-${invoiceItemCounter}`;
        itemDiv.setAttribute("data-manual", "true");

        itemDiv.innerHTML = `
                <input type="text" placeholder="‡§Ü‡§á‡§ü‡§Æ ‡§ï‡§æ ‡§®‡§æ‡§Æ" onchange="updateInvoiceSummary()">
                <select onchange="updateInvoiceSummary()" data-metal-select="true">
                    <option value="">‡§ß‡§æ‡§§‡•Å ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                    <option value="gold">ü™ô ‡§∏‡•ã‡§®‡§æ (Gold)</option>
                    <option value="silver">‚ö™ ‡§ö‡§æ‡§Ç‡§¶‡•Ä (Silver)</option>
                </select>
                <input type="number" placeholder="‡§µ‡§ú‡§® (g)" oninput="updateInvoiceSummary()" min="0" step="0.01">
                <input type="number" placeholder="‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ" oninput="updateInvoiceSummary()" min="1" value="1">
                <div>
                    <select onchange="updateInvoiceSummary()">
                        <option value="pg">‡§™‡•ç‡§∞‡§§‡§ø ‡§ó‡•ç‡§∞‡§æ‡§Æ (Per Gram)</option>
                        <option value="ppc">‡§™‡•ç‡§∞‡§§‡§ø ‡§™‡•Ä‡§∏ (Per Piece)</option>
                        <option value="pkg">‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã (Per KG)</option>
                        <option value="fixed">‡§´‡§ø‡§ï‡•ç‡§∏‡•ç‡§° (Fixed)</option>
                        <option value="percent">‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ (Percentage)</option>
                    </select>
                    <input type="number" placeholder="‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä" oninput="updateInvoiceSummary()" min="0">
                </div>
                <button class="remove-item-btn" onclick="removeInvoiceItem(${invoiceItemCounter})">‡§π‡§ü‡§æ‡§è‡§Ç</button>
            `;

        // --- Stone/Extra Charges Panel (hidden by default) ---
        const stonePanel = document.createElement("div");
        stonePanel.className = "stone-panel";
        stonePanel.style.display = "none";
        stonePanel.innerHTML = `
        <div class="stone-row">
            <input type="number" class="stone-weight-input" placeholder="‡§∏‡•ç‡§ü‡•ã‡§® ‡§µ‡§ú‡§® (‡§ó‡•ç‡§∞‡§æ‡§Æ)" step="0.01" oninput="updateInvoiceSummary()">
            <input type="number" class="stone-charges-input" placeholder="‡§∏‡•ç‡§ü‡•ã‡§® ‡§ö‡§æ‡§∞‡•ç‡§ú (‚Çπ)" step="0.01" oninput="updateInvoiceSummary()">
        </div>
        <div class="extra-charges-list"></div>
        <button type="button" class="extra-charge-btn" onclick="addExtraCharge(this)">+ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
    `;
        itemDiv.appendChild(stonePanel);

        // Show stone panel only if manual metal is gold
        const metalSelect = itemDiv.querySelector(
          'select[data-metal-select="true"]'
        );
        function toggleStonePanelManual() {
          if (metalSelect && metalSelect.value === "gold") {
            stonePanel.style.display = "block";
          } else {
            stonePanel.style.display = "none";
            const sw = itemDiv.querySelector(".stone-weight-input");
            if (sw) sw.value = "";
            const sc = itemDiv.querySelector(".stone-charges-input");
            if (sc) sc.value = "";
            const list = itemDiv.querySelector(".extra-charges-list");
            if (list) list.innerHTML = "";
          }
          updateInvoiceSummary();
        }
        if (metalSelect) {
          metalSelect.addEventListener("change", toggleStonePanelManual);
        }
        container.appendChild(itemDiv);
        invoiceItemCounter++;
      }

      function removeInvoiceItem(id) {
        const item = document.getElementById(`item-${id}`);
        if (item) {
          item.remove();
          updateInvoiceSummary();
        }
      }

      function toggleOldJewellery() {
        const checkbox = document.getElementById("hasOldJewellery");
        const section = document.getElementById("oldJewellerySection");
        section.style.display = checkbox.checked ? "block" : "none";
        updateInvoiceSummary();
      }

      // Calculate old metal amount based on weight, tounch and rate
      function calculateOldMetalAmount() {
        const weight = parseFloat(document.getElementById("oldMetalWeight").value) || 0;
        const tounch = parseFloat(document.getElementById("oldMetalTounch").value) || 0;
        const rate10g = parseFloat(document.getElementById("oldMetalRate10g").value) || 0;
        
        // Formula: Weight √ó (Tounch √∑ 100) √ó (Rate(10g) √∑ 10)
        const result = weight * (tounch / 100) * (rate10g / 10);
        
        document.getElementById("oldMetalCalculatedAmount").value = result.toFixed(2);
      }

      // Copy calculated amount to old jewellery amount field
      function copyCalculatedAmount() {
        const calculatedAmount = document.getElementById("oldMetalCalculatedAmount").value;
        const oldJewelleryAmountField = document.getElementById("oldJewelleryAmount");
        
        if (calculatedAmount && parseFloat(calculatedAmount) > 0) {
          oldJewelleryAmountField.value = calculatedAmount;
          
          // Show a brief success indication
          const button = event.target;
          const originalText = button.innerHTML;
          button.innerHTML = "‚úì Copied!";
          button.style.background = "#218838";
          
          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = "#28a745";
          }, 1500);
          
          // Update invoice summary
          updateInvoiceSummary();
        } else {
          showNotification("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç (Please calculate first)", "error");
        }
      }


      function updateInvoiceSummary() {
        let totalMetalValue = 0;
        let totalLabour = 0;

        const items = document.querySelectorAll(".invoice-item");
        items.forEach((item) => {
          const isManual = item.getAttribute("data-manual") === "true";
          let metalType = "";
          let weight = 0;
          let qty = 1;
          let labourType = "pg";
          let labourValue = 0;

          if (isManual) {
            const itemName = item.querySelector('input[type="text"]').value;
            const metalSelect = item.querySelector(
              'select[data-metal-select="true"]'
            );
            metalType = metalSelect ? metalSelect.value : "";
            const inputs = item.querySelectorAll('input[type="number"]');
            weight = parseFloat(inputs[0].value) || 0;
            qty = parseInt(inputs[1].value) || 1;
            const selects = item.querySelectorAll("select");
            labourType = selects[1] ? selects[1].value : "pg";
            labourValue = parseFloat(inputs[2].value) || 0;
            if (!(itemName && metalType && weight > 0)) {
              // skip incomplete row
              return;
            }
          } else {
            const select = item.querySelector("select");
            const inputs = item.querySelectorAll("input");
            if (!(select.value && inputs[0].value && inputs[1].value)) {
              return;
            }
            const itemId = parseInt(select.value);
            const invItem = appData.inventory.find((i) => i.id === itemId);
            if (!invItem) return;
            metalType = invItem.metalType;
            weight = parseFloat(inputs[0].value) || 0;
            qty = parseInt(inputs[1].value) || 1;
            labourType = item.querySelectorAll("select")[1].value;
            labourValue =
              parseFloat(item.querySelectorAll("input")[2].value) || 0;
          }

          // Base metal rate per gram
          let metalRatePerGram = 0;
          if (metalType === "gold") {
            metalRatePerGram = appData.metalRates.gold / 10;
          } else if (metalType === "silver") {
            metalRatePerGram = appData.metalRates.silver / 10;
          }

          // Stone deductions and charges (only for gold)
          let stoneWeight = 0;
          let stoneCharges = 0;
          let extraChargesSum = 0;

          const stonePanel = item.querySelector(".stone-panel");
          if (stonePanel && metalType === "gold") {
            const sw = stonePanel.querySelector(".stone-weight-input");
            const sc = stonePanel.querySelector(".stone-charges-input");
            stoneWeight = sw ? parseFloat(sw.value) || 0 : 0;
            stoneCharges = sc ? parseFloat(sc.value) || 0 : 0;
            stoneWeight = Math.max(stoneWeight, 0);
            // Collect extra charges
            stonePanel
              .querySelectorAll(".extra-charge-amount")
              .forEach((inp) => {
                extraChargesSum += parseFloat(inp.value) || 0;
              });
          }

          const effectiveWeight = Math.max(
            weight - (metalType === "gold" ? stoneWeight : 0),
            0
          );

          // Metal value uses effective weight
          totalMetalValue += effectiveWeight * metalRatePerGram * qty;

          // Labour calc
          switch (labourType) {
            case "pg":
              totalLabour += labourValue * weight * qty;
              break;
            case "ppc":
              totalLabour += labourValue * qty;
              break;
            case "pkg":
              totalLabour += (labourValue * weight * qty) / 1000;
              break;
            case "fixed":
              totalLabour += labourValue;
              break;
            case "percent":
              totalLabour +=
                (weight * metalRatePerGram * qty * labourValue) / 100;
              break;
          }
          // Add stone/extra charges into labour bucket
          totalLabour += stoneCharges + extraChargesSum;
        });

        const subtotal = totalMetalValue + totalLabour;
        const oldMetalDeduction = document.getElementById("hasOldJewellery")
          .checked
          ? parseFloat(document.getElementById("oldJewelleryAmount").value) || 0
          : 0;

        // Get discount value
        const finalDiscount =
          parseFloat(document.getElementById("finalDiscountInput").value) || 0;

        const previousBalance =
          parseFloat(document.getElementById("previousBalance").textContent) ||
          0;
        const received =
          parseFloat(document.getElementById("amountReceived").value) || 0;

        let grandTotal;
        let discountedTotal;
        let totalWithPrevious;
        let totalReceived;
        let balance;

        // If current bill has items (amount is NOT 0)
        if (subtotal > 0) {
          // Normal billing with items
          grandTotal = subtotal - oldMetalDeduction;
          discountedTotal = Math.max(0, grandTotal - finalDiscount);
          totalWithPrevious = discountedTotal + previousBalance;
          totalReceived = received;
          balance = totalWithPrevious - totalReceived;
        }
        // If current bill is empty (amount is 0) - PAYMENT ONLY transaction
        else {
          // This is a payment transaction
          grandTotal = 0;
          discountedTotal = 0;

          // Apply discount to previous balance first
          const balanceAfterDiscount = previousBalance - finalDiscount;
          totalWithPrevious = balanceAfterDiscount;

          // BOTH old jewellery AND cash are payments
          totalReceived = received + oldMetalDeduction;
          balance = totalWithPrevious - totalReceived;
        }

        document.getElementById("totalMetalValue").textContent =
          totalMetalValue.toFixed(2);
        document.getElementById("totalLabour").textContent =
          totalLabour.toFixed(2);
        document.getElementById("subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("oldMetalDeduction").textContent =
          oldMetalDeduction.toFixed(2);
        document.getElementById("grandTotal").textContent =
          grandTotal.toFixed(2);
        document.getElementById("discountedTotal").textContent =
          discountedTotal.toFixed(2);
        document.getElementById("totalWithPrevious").textContent =
          totalWithPrevious.toFixed(2);
        document.getElementById("receivedAmount").textContent =
          totalReceived.toFixed(2);
        document.getElementById("balanceDue").textContent = balance.toFixed(2);
      }

      // Customer Search
      function searchCustomer(phone) {
        if (phone.length === 10) {
          const customer = appData.customers[phone];
          if (customer) {
            document.getElementById("customerName").value = customer.name;
            // Show previous balance (positive or negative)
            if (customer.balance !== 0) {
              const balanceRow = document.getElementById("previousBalanceRow");
              const balanceSpan = document.getElementById("previousBalance");
              const balanceLabel = balanceRow.querySelector("span:first-child");

              balanceRow.style.display = "flex";
              balanceSpan.textContent = customer.balance.toFixed(2);

              // Update label and color based on balance type
              if (customer.balance > 0) {
                // Positive balance - customer owes money
                balanceRow.style.background = "#fff3cd";
                balanceLabel.style.color = "#856404";
                balanceLabel.innerHTML = "‚ö†Ô∏è ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ:";
              } else {
                // Negative balance - customer has advance/credit
                balanceRow.style.background = "#d4edda";
                balanceLabel.style.color = "#155724";
                balanceLabel.innerHTML = "üí∞ ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§∞‡§æ‡§∂‡§ø (-):";
              }
            } else {
              document.getElementById("previousBalanceRow").style.display =
                "none";
              document.getElementById("previousBalance").textContent = "0";
            }
            updateInvoiceSummary();
          } else {
            document.getElementById("previousBalanceRow").style.display =
              "none";
            document.getElementById("previousBalance").textContent = "0";
            updateInvoiceSummary();
          }
        } else {
          document.getElementById("previousBalanceRow").style.display = "none";
          document.getElementById("previousBalance").textContent = "0";
          updateInvoiceSummary();
        }
      }

      function fillPhoneFromName(name) {
        if (name.length > 2) {
          // Find customer by name
          const customer = Object.values(appData.customers).find(
            (c) => c.name.toLowerCase() === name.toLowerCase()
          );
          if (customer) {
            document.getElementById("customerPhone").value = customer.phone;
            searchCustomer(customer.phone);
          }
        }
      }

      function populateCustomerDatalist() {
        try {
          const nameList = document.getElementById("customerNameList");
          const phoneList = document.getElementById("customerPhoneList");

          if (!nameList || !phoneList) {
            console.log("Datalist elements not found yet");
            return;
          }

          nameList.innerHTML = "";
          phoneList.innerHTML = "";

          Object.values(appData.customers).forEach((customer) => {
            // Add to name datalist
            const nameOption = document.createElement("option");
            nameOption.value = customer.name;
            nameList.appendChild(nameOption);

            // Add to phone datalist
            const phoneOption = document.createElement("option");
            phoneOption.value = customer.phone;
            phoneOption.textContent = `${customer.name} - ${customer.phone}`;
            phoneList.appendChild(phoneOption);
          });
        } catch (error) {
          console.error("Error in populateCustomerDatalist:", error);
        }
      }

      // Generate Invoice
      function generateInvoice() {
        updateInvoiceSummary(); // ensure latest totals

        const phone = document.getElementById("customerPhone").value.trim();
        const name = document.getElementById("customerName").value.trim();

        if (!phone || phone.length !== 10) {
          showNotification("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!", "error");
          return;
        }

        if (!name) {
          showNotification("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!", "error");
          return;
        }

        const items = [];
        const itemElements = document.querySelectorAll(".invoice-item");

        itemElements.forEach((item) => {
          const isManual = item.getAttribute("data-manual") === "true";

          if (isManual) {
            // Manual item
            const itemName = item.querySelector('input[type="text"]').value;
            const metalSelect = item.querySelector(
              'select[data-metal-select="true"]'
            );
            const metalType = metalSelect ? metalSelect.value : "";
            const inputs = item.querySelectorAll('input[type="number"]');
            const weight = parseFloat(inputs[0].value) || 0;
            const qty = parseInt(inputs[1].value) || 1;
            const labourSelects = item.querySelectorAll("select");
            const labourType = labourSelects[1] ? labourSelects[1].value : "pg";
            const labourValue = parseFloat(inputs[2].value) || 0;

            if (itemName && metalType && weight > 0) {
              items.push({
                name: itemName,
                metalType,
                weight,
                qty,
                labourType,
                labourValue,
                isManual: true,
                stoneWeight: (function () {
                  const sp = item.querySelector(".stone-weight-input");
                  return sp ? parseFloat(sp.value) || 0 : 0;
                })(),
                stoneCharges: (function () {
                  const sc = item.querySelector(".stone-charges-input");
                  return sc ? parseFloat(sc.value) || 0 : 0;
                })(),
                extraCharges: (function () {
                  const arr = [];
                  item.querySelectorAll(".extra-charge-row").forEach((r) => {
                    const d =
                      r.querySelector(".extra-charge-desc")?.value?.trim() ||
                      "";
                    const a =
                      parseFloat(
                        r.querySelector(".extra-charge-amount")?.value
                      ) || 0;
                    if (d || a) {
                      arr.push({ desc: d, amount: a });
                    }
                  });
                  return arr;
                })(),
              });
            }
          } else {
            // Inventory item
            const select = item.querySelector("select");
            const inputs = item.querySelectorAll("input");

            if (select.value && inputs[0].value && inputs[1].value) {
              const itemId = parseInt(select.value);
              const inventoryItem = appData.inventory.find(
                (i) => i.id === itemId
              );

              if (inventoryItem) {
                const weight = parseFloat(inputs[0].value) || 0;
                const qty = parseInt(inputs[1].value) || 1;
                const labourType = item.querySelectorAll("select")[1].value;
                const labourValue =
                  parseFloat(item.querySelectorAll("input")[2].value) || 0;

                items.push({
                  name: inventoryItem.name,
                  metalType: inventoryItem.metalType,
                  weight,
                  qty,
                  labourType,
                  labourValue,
                  isManual: false,
                  inventoryId: itemId,
                  stoneWeight: (function () {
                    const sp = item.querySelector(".stone-weight-input");
                    return sp ? parseFloat(sp.value) || 0 : 0;
                  })(),
                  stoneCharges: (function () {
                    const sc = item.querySelector(".stone-charges-input");
                    return sc ? parseFloat(sc.value) || 0 : 0;
                  })(),
                  extraCharges: (function () {
                    const arr = [];
                    item.querySelectorAll(".extra-charge-row").forEach((r) => {
                      const d =
                        r.querySelector(".extra-charge-desc")?.value?.trim() ||
                        "";
                      const a =
                        parseFloat(
                          r.querySelector(".extra-charge-amount")?.value
                        ) || 0;
                      if (d || a) {
                        arr.push({ desc: d, amount: a });
                      }
                    });
                    return arr;
                  })(),
                });

                // Reduce inventory
                const invItem = appData.inventory.find((i) => i.id === itemId);
                if (invItem) {
                  invItem.weight -= weight * qty;
                  invItem.pcs -= qty;
                }
              }
            }
          }
        });

        // Check if this is a payment-only invoice
        const hasOldJewellery =
          document.getElementById("hasOldJewellery").checked;
        const oldJewelleryAmount =
          parseFloat(document.getElementById("oldJewelleryAmount").value) || 0;
        const amountReceived =
          parseFloat(document.getElementById("amountReceived").value) || 0;
        const previousBalance =
          parseFloat(document.getElementById("previousBalance").textContent) ||
          0;
        const finalDiscount =
          parseFloat(document.getElementById("finalDiscountInput")?.value) || 0;
        const discountedTotalUI =
          parseFloat(document.getElementById("discountedTotal")?.textContent) ||
          0;

        // Allow invoice if: has items OR has old jewellery OR is payment for previous balance
        if (
          items.length === 0 &&
          !hasOldJewellery &&
          previousBalance === 0 &&
          document.getElementById("paymentType").value !== "advance"
        ) {
          showNotification("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç!", "error");
          return;
        }

        // Create invoice with current totals
        const currentMetalValue = parseFloat(
          document.getElementById("totalMetalValue").textContent
        );
        const currentLabour = parseFloat(
          document.getElementById("totalLabour").textContent
        );
        const currentSubtotal = parseFloat(
          document.getElementById("subtotal").textContent
        );
        const oldMetalDeduction = parseFloat(
          document.getElementById("oldMetalDeduction").textContent
        );
        const grandTotal = parseFloat(
          document.getElementById("grandTotal").textContent
        );
        const totalWithPrevious = parseFloat(
          document.getElementById("totalWithPrevious").textContent
        );
        const balance = parseFloat(
          document.getElementById("balanceDue").textContent
        );

        const invoice = {
          id: Date.now(),
          date: new Date().toISOString(),
          customer: { phone, name },
          items,
          oldJewellery: hasOldJewellery
            ? {
                amount: oldJewelleryAmount,
                description: document
                  .getElementById("oldJewelleryDesc")
                  .value.trim(),
                calculation: {
                  weight: parseFloat(document.getElementById("oldMetalWeight").value) || 0,
                  tounch: parseFloat(document.getElementById("oldMetalTounch").value) || 0,
                  rate10g: parseFloat(document.getElementById("oldMetalRate10g").value) || 0,
                  calculatedAmount: parseFloat(document.getElementById("oldMetalCalculatedAmount").value) || 0
                }
              }
            : null,
          payment: {
            type: document.getElementById("paymentType").value,
            received: amountReceived,
          },
          totals: {
            metalValue: currentMetalValue,
            labour: currentLabour,
            subtotal: currentSubtotal,
            oldMetalDeduction: oldMetalDeduction,
            grandTotal: grandTotal,
            previousBalance: previousBalance,
            totalWithPrevious: totalWithPrevious,
            finalDiscount: finalDiscount,
            discountedTotal: discountedTotalUI,
            balance: balance,
          },
          isPaymentOnly: items.length === 0,
        };

        appData.invoices.push(invoice);

        // Update or create customer
        if (!appData.customers[phone]) {
          appData.customers[phone] = {
            name,
            phone,
            totalPurchase: 0,
            totalPaid: 0,
            balance: 0,
            invoices: [],
          };
        }

        // Update customer balance
        const customer = appData.customers[phone];

        // Simply use the balance from invoice summary - no separate calculation needed
        // This ensures customer ledger exactly matches what was shown on invoice
        customer.balance = balance;
        customer.invoices.push(invoice.id);

        saveData();
        renderInventory();
        renderCustomers();
        populateCustomerDatalist();
        updateAccountingStats();

        printInvoice(invoice);

        // Clear form
        document.getElementById("customerPhone").value = "";
        document.getElementById("customerName").value = "";
        document.getElementById("invoiceItems").innerHTML = "";
        document.getElementById("hasOldJewellery").checked = false;
        document.getElementById("oldJewellerySection").style.display = "none";
        
        // Clear old jewellery calculation fields
        document.getElementById("oldMetalWeight").value = "";
        document.getElementById("oldMetalTounch").value = "";
        document.getElementById("oldMetalRate10g").value = "";
        document.getElementById("oldMetalCalculatedAmount").value = "";
        document.getElementById("oldJewelleryAmount").value = "";
        document.getElementById("oldJewelleryDesc").value = "";
        
        document.getElementById("amountReceived").value = "";
        document.getElementById("finalDiscountInput").value = "0";
        document.getElementById("previousBalanceRow").style.display = "none";
        updateInvoiceSummary();

        showNotification("‚úì ‡§¨‡§ø‡§≤ ‡§¨‡§® ‡§ó‡§Ø‡§æ!", "success");
      }

      function printInvoice(invoice) {
        const printDiv = document.getElementById("printInvoice");
        const date = new Date(invoice.date).toLocaleString("hi-IN");

        let itemsHTML = "";

        if (invoice.items && invoice.items.length > 0) {
          invoice.items.forEach((item, index) => {
            let metalRatePerGram = 0;
            if (item.metalType === "gold") {
              metalRatePerGram = appData.metalRates.gold / 10;
            } else if (item.metalType === "silver") {
              metalRatePerGram = appData.metalRates.silver / 10;
            }

            const stoneWeight =
              item.metalType === "gold" ? item.stoneWeight || 0 : 0;
            const effectiveWeight = Math.max(item.weight - stoneWeight, 0);
            const metalValue = effectiveWeight * metalRatePerGram * item.qty;

            let labourAmount = 0;
            let labourText = "";
            switch (item.labourType) {
              case "pg":
                labourAmount = item.labourValue * item.weight * item.qty;
                labourText = `${item.labourValue}/g`;
                break;
              case "ppc":
                labourAmount = item.labourValue * item.qty;
                labourText = `${item.labourValue}/pc`;
                break;
              case "pkg":
                labourAmount =
                  (item.labourValue * item.weight * item.qty) / 1000;
                labourText = `${item.labourValue}/kg`;
                break;
              case "fixed":
                labourAmount = item.labourValue;
                labourText = `Fixed ‚Çπ${item.labourValue}`;
                break;
              case "percent":
                labourAmount = (metalValue * item.labourValue) / 100;
                labourText = `${item.labourValue}%`;
                break;
            }

            const stoneCharges = item.stoneCharges || 0;
            let extraChargesSum = 0;
            if (item.extraCharges && item.extraCharges.length) {
              item.extraCharges.forEach((ec) => {
                extraChargesSum += parseFloat(ec.amount) || 0;
              });
            }
            labourAmount += stoneCharges + extraChargesSum;

            const metalIcon = item.metalType === "gold" ? "ü™ô" : "‚ö™";

            itemsHTML += `
            <tr>
                <td>${index + 1}</td>
                <td>${metalIcon} ${item.name}</td>
                <td>${item.weight}g</td>
                <td>${item.qty}</td>
                <td>‚Çπ${metalValue.toFixed(2)}</td>
                <td>${labourText}</td>
                <td>‚Çπ${labourAmount.toFixed(2)}</td>
                <td>‚Çπ${(metalValue + labourAmount).toFixed(2)}</td>
            </tr>
            ${
              item.metalType === "gold" && (item.stoneWeight || 0) > 0
                ? `<tr><td></td><td colspan="7">üíé Stone Weight: ${
                    item.stoneWeight
                  }g, Stone Charges: ‚Çπ${(item.stoneCharges || 0).toFixed(
                    2
                  )}</td></tr>`
                : ""
            }
            ${
              item.extraCharges && item.extraCharges.length
                ? item.extraCharges
                    .map(
                      (ec) =>
                        `<tr><td></td><td colspan="7">‚ûï ${
                          ec.desc || "Extra"
                        }: ‚Çπ${(parseFloat(ec.amount) || 0).toFixed(
                          2
                        )}</td></tr>`
                    )
                    .join("")
                : ""
            }
        `;
          });
        } else {
          // Payment-only invoice (advance, balance payment, etc)
          const paymentType =
            invoice.payment.type === "advance"
              ? "‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®"
              : invoice.oldJewellery
              ? "‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å"
              : "‡§¨‡§æ‡§ï‡•Ä ‡§≠‡•Å‡§ó‡§§‡§æ‡§®";
          itemsHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; font-size: 16px;">
                            ${paymentType}
                        </td>
                    </tr>
                `;
        }

        printDiv.innerHTML = `
                <div class="print-header">
                    <h1 style="margin: 0; font-size: 28px; color: #667eea;">‚ú® ‡§∏‡§æ‡§Ç‡§µ‡§∞‡§ø‡§Ø‡§æ ‡§ú‡•Ä ‡§ú‡•ç‡§µ‡•à‡§≤‡§∞‡•ç‡§∏ ‚ú®</h1>
                    <div>
                        <p style="margin: 3px 0; font-size: 14px;"><strong>Ugam Raj Soni</strong></p>
                        <p style="margin: 3px 0; font-size: 13px;">üìû 9351896678</p>
                        <p style="margin: 3px 0; font-size: 13px;">üìç 36, ‡§∞‡•Å‡§à ‡§ï‡§ü‡§≤‡§æ, ‡§®‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§¢‡§æ‡§≤ ‡§ï‡•á ‡§¨‡§æ‡§π‡§∞,Pali, India</p>
                    </div>

                    <p style="margin-top: 5px; color: red; font-size: 11px;"><strong>This is not a Tax Invoice</strong></p>
                </div>

                <div class="invoice-info">
                    <div>
                        <p><strong>‡§¨‡§ø‡§≤ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï:</strong> ${invoice.id}</p>
                        <p><strong>‡§§‡§æ‡§∞‡•Ä‡§ñ:</strong> ${date}</p>
                    </div>
                    <div>
                        <p><strong>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${
                          invoice.customer.name
                        }</p>
                        <p><strong>‡§´‡•ã‡§®:</strong> ${invoice.customer.phone}</p>
                    </div>
                </div>

                <table class="print-table">
                    <thead>
                        <tr>
                            <th>‡§ï‡•ç‡§∞.</th>
                            <th>‡§Ü‡§á‡§ü‡§Æ</th>
                            <th>‡§µ‡§ú‡§®</th>
                            <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                            <th>‡§ß‡§æ‡§§‡•Å ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</th>
                            <th>‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä</th>
                            <th>‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä ‡§∞‡§æ‡§∂‡§ø</th>
                            <th>‡§ï‡•Å‡§≤</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>

                <div style="margin-top: 20px; text-align: right;">
                    <p><strong>‡§ï‡•Å‡§≤ ‡§ß‡§æ‡§§‡•Å ‡§Æ‡•Ç‡§≤‡•ç‡§Ø:</strong> ‚Çπ${invoice.totals.metalValue.toFixed(
                      2
                    )}</p>
                    <p><strong>‡§ï‡•Å‡§≤ ‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä:</strong> ‚Çπ${invoice.totals.labour.toFixed(
                      2
                    )}</p>
                    <p><strong>‡§â‡§™-‡§Ø‡•ã‡§ó:</strong> ‚Çπ${invoice.totals.subtotal.toFixed(
                      2
                    )}</p>
                    ${
                      invoice.oldJewellery
                        ? `<p><strong>‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å (-):</strong> ‚Çπ${invoice.oldJewellery.amount.toFixed(
                            2
                          )}</p>`
                        : ""
                    }
                    ${
                      invoice.oldJewellery && invoice.oldJewellery.description
                        ? `<p style="font-size: 12px;"><em>${invoice.oldJewellery.description}</em></p>`
                        : ""
                    }
                    <p style="font-size: 20px; margin-top: 10px;"><strong>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${invoice.totals.grandTotal.toFixed(
                      2
                    )}</p>
                    ${
                      invoice.totals.finalDiscount > 0
                        ? `<p style="color: #28a745;"><strong>‡§õ‡•Ç‡§ü/‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü (-):</strong> ‚Çπ${invoice.totals.finalDiscount.toFixed(
                            2
                          )}</p>`
                        : ""
                    }
                    ${
                      invoice.totals.finalDiscount > 0
                        ? `<p style="font-size: 18px;"><strong>‡§õ‡•Ç‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶:</strong> ‚Çπ${invoice.totals.discountedTotal.toFixed(
                            2
                          )}</p>`
                        : ""
                    }
                    
                    ${
                      invoice.totals.previousBalance !== 0
                        ? `
                        <div style="border-top: 2px dashed #667eea; margin: 15px 0; padding-top: 10px;">
                            ${
                              invoice.totals.previousBalance > 0
                                ? `<p style="color: #dc3545; font-size: 16px;"><strong>‚ö†Ô∏è ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§¨‡§æ‡§ï‡•Ä (+):</strong> ‚Çπ${invoice.totals.previousBalance.toFixed(
                                    2
                                  )}</p>
                                 <p style="font-size: 18px;"><strong>‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${invoice.totals.totalWithPrevious.toFixed(
                                   2
                                 )}</p>`
                                : `<p style="color: #28a745; font-size: 16px;"><strong>üí∞ ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§∞‡§æ‡§∂‡§ø (-):</strong> ‚Çπ${Math.abs(
                                    invoice.totals.previousBalance
                                  ).toFixed(2)}</p>
                                 <p style="font-size: 18px;"><strong>‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¶‡•á‡§Ø:</strong> ‚Çπ${invoice.totals.totalWithPrevious.toFixed(
                                   2
                                 )}</p>`
                            }
                        </div>
                    `
                        : ""
                    }
                    
                    <p style="margin-top: 10px;"><strong>‡§®‡§ï‡§¶ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${invoice.payment.received.toFixed(
                      2
                    )}</p>
                    <p style="font-size: 20px; margin-top: 5px; color: ${
                      invoice.totals.balance > 0
                        ? "red"
                        : invoice.totals.balance < 0
                        ? "green"
                        : "black"
                    };">
                        <strong>${
                          invoice.totals.balance > 0
                            ? "‚ö†Ô∏è ‡§¨‡§æ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø:"
                            : invoice.totals.balance < 0
                            ? "‚úÖ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ú‡§Æ‡§æ:"
                            : "‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®:"
                        }</strong> 
                        ‚Çπ${Math.abs(invoice.totals.balance).toFixed(2)}
                    </p>
                </div>

                <div style="margin-top: 40px; border-top: 2px solid #000; padding-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="text-align: center;">
                            <p style="margin-bottom: 50px; font-size: 14px; color: #666;">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§®‡•ã‡§ü:</p>
                            <p style="font-size: 11px; color: #666;">‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§ø‡§≤ ‡§∏‡§Ç‡§≠‡§æ‡§≤ ‡§ï‡§∞ ‡§∞‡§ñ‡•á‡§Ç</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin-bottom: 50px; font-size: 14px;"><strong>‡§¶‡•Å‡§ï‡§æ‡§® ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§è‡§µ‡§Ç ‡§Æ‡•Å‡§π‡§∞</strong></p>
                            <div style="border-top: 2px solid #000; width: 150px;"></div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: center; border-top: 1px dashed #666; padding-top: 15px;">
                    <p style="font-size: 16px; font-weight: bold;">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§´‡§ø‡§∞ ‡§Ü‡§á‡§è‡§ó‡§æ! üôè</p>
                    <p style="font-size: 12px; margin-top: 5px; color: #666;">Thank you for your business!</p>
                                        <p style="margin: 8px 0; font-size: 12px; background: #fff3cd; padding: 5px; border-radius: 5px; color: #856404;">
                        üèÜ <strong>Hallmark Jewellery</strong> - ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∏‡•á ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ‡§à ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à
                    </p>
                </div>
                
                <!-- Print Buttons (Hidden in print) -->
                <div class="no-print" style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="printInvoiceNow()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                    </button>
                    <button onclick="saveAsPDF()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        üíæ PDF ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                    </button>
                    <button onclick="closeInvoicePreview()" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        ‚ùå ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
                    </button>
                </div>
            `;

        // Show preview without automatic print
        printDiv.style.display = "block";

        // Scroll to top to see the invoice
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Function to manually print the invoice
      function printInvoiceNow() {
        window.print();
      }

      // Function to save as PDF (uses browser's print to PDF feature)
      function saveAsPDF() {
        alert(
          'üìÑ ‡§Ö‡§™‡§®‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•á Print dialog ‡§Æ‡•á‡§Ç "Save as PDF" ‡§Ø‡§æ "Print to PDF" ‡§ö‡•Å‡§®‡•á‡§Ç'
        );
        window.print();
      }

      // Function to close the invoice preview
      function closeInvoicePreview() {
        const printDiv = document.getElementById("printInvoice");
        printDiv.style.display = "none";
        printDiv.innerHTML = "";
      }

      function addExtraCharge(btn) {
        const panel = btn.closest(".stone-panel");
        if (!panel) return;
        const list = panel.querySelector(".extra-charges-list");
        const row = document.createElement("div");
        row.className = "extra-charge-row";
        row.innerHTML = `
        <input type="text" class="extra-charge-desc" placeholder="‡§µ‡§ø‡§µ‡§∞‡§£ (‡§ú‡•à‡§∏‡•á: ‡§™‡•â‡§≤‡§ø‡§∂, ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó)" oninput="updateInvoiceSummary()">
        <input type="number" class="extra-charge-amount" placeholder="‡§∞‡§æ‡§∂‡§ø (‚Çπ)" step="0.01" oninput="updateInvoiceSummary()">
        <button type="button" class="remove-extra-btn">‚úï</button>
    `;
        row.querySelector(".remove-extra-btn").onclick = function () {
          row.remove();
          updateInvoiceSummary();
        };
        list.appendChild(row);
        updateInvoiceSummary();
      }

      // Customer Ledger
      function renderCustomers() {
        const tbody = document.getElementById("customersBody");
        tbody.innerHTML = "";

        Object.values(appData.customers).forEach((customer) => {
          const row = tbody.insertRow();
          row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>‚Çπ${customer.totalPurchase.toFixed(2)}</td>
                    <td style="color: ${
                      customer.balance > 0
                        ? "#dc3545"
                        : customer.balance < 0
                        ? "#28a745"
                        : "#666"
                    }; font-weight: bold;">
                        ${
                          customer.balance < 0
                            ? "(+) ‚Çπ" + Math.abs(customer.balance).toFixed(2)
                            : "‚Çπ" + customer.balance.toFixed(2)
                        }
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-view" onclick="viewCustomerDetails('${
                              customer.phone
                            }')">‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </div>
                    </td>
                `;
        });
      }

      function formatLedgerItem(item) {
        const metalIcon = item.metalType === "gold" ? "ü™ô" : "‚ö™";
        const labourText =
          item.labourType === "pg"
            ? item.labourValue + "/g"
            : item.labourType === "ppc"
            ? item.labourValue + "/pc"
            : item.labourType === "pkg"
            ? item.labourValue + "/kg"
            : item.labourType === "fixed"
            ? "‚Çπ" + item.labourValue
            : item.labourValue + "%";

        const stonePart =
          item.metalType === "gold" &&
          ((item.stoneWeight || 0) > 0 || (item.stoneCharges || 0) > 0)
            ? `<p style="margin:0;"><strong>‡§∏‡•ç‡§ü‡•ã‡§® ‡§µ‡§ú‡§®:</strong> ${
                item.stoneWeight || 0
              }g</p>
                   <p style="margin:0;"><strong>‡§∏‡•ç‡§ü‡•ã‡§® ‡§ö‡§æ‡§∞‡•ç‡§ú:</strong> ‚Çπ${(
                     item.stoneCharges || 0
                   ).toFixed(2)}</p>`
            : "";

        const extrasPart =
          item.extraCharges && item.extraCharges.length
            ? `<div style="margin-top:4px;"><strong>‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ö‡§æ‡§∞‡•ç‡§ú:</strong> ${item.extraCharges
                .map((ec) => {
                  const d = (ec.desc || "‡§Ö‡§®‡•ç‡§Ø")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                  const a = (parseFloat(ec.amount) || 0).toFixed(2);
                  return d + ": ‚Çπ" + a;
                })
                .join(", ")}</div>`
            : "";

        return `
                <div style="background:#f8f9fa; padding:10px; margin:8px 0; border-radius:5px; border-left:3px solid #667eea;">
                    <p style="margin:0; font-weight:bold; font-size:14px;">${metalIcon} ${item.name}</p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:5px; font-size:13px;">
                        <p style="margin:0;"><strong>‡§µ‡§ú‡§®:</strong> ${item.weight}g</p>
                        <p style="margin:0;"><strong>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ:</strong> ${item.qty}</p>
                        <p style="margin:0;"><strong>‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä:</strong> ${labourText}</p>
                        ${stonePart}
                    </div>
                    ${extrasPart}
                </div>`;
      }

      function viewCustomerDetails(phone) {
        const customer = appData.customers[phone];
        if (!customer) return;

        // Get all invoices for this customer - sorted latest first
        const customerInvoices = appData.invoices
          .filter((inv) => inv.customer.phone === phone)
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        let invoicesHTML = "";
        if (customerInvoices.length > 0) {
          customerInvoices.forEach((inv, index) => {
            const date = new Date(inv.date).toLocaleDateString("hi-IN");
            const time = new Date(inv.date).toLocaleTimeString("hi-IN");

            // Build items list
            let itemsList = "";
            if (inv.items && inv.items.length > 0) {
              inv.items.forEach((item) => {
                itemsList += formatLedgerItem(item);
              });
            } else {
              // Payment-only invoice
              const paymentType =
                inv.payment.type === "advance"
                  ? "üéÅ ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®"
                  : inv.oldJewellery
                  ? "‚ôªÔ∏è ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å"
                  : "üí∞ ‡§¨‡§æ‡§ï‡•Ä ‡§≠‡•Å‡§ó‡§§‡§æ‡§®";
              itemsList = `
                            <div style="background: #e7f3ff; padding: 15px; margin: 8px 0; border-radius: 5px; border-left: 3px solid #2196F3; text-align: center;">
                                <p style="margin: 0; font-weight: bold; font-size: 14px; color: #2196F3;">${paymentType}</p>
                            </div>
                        `;
            }

            invoicesHTML += `
                        <div class="card" style="margin-bottom: 15px; border-left: 4px solid ${
                          inv.totals.balance > 0 ? "#dc3545" : "#28a745"
                        };">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <h4 style="margin: 0; color: #667eea; font-size: 16px;">‡§¨‡§ø‡§≤ #${
                                      inv.id
                                    }</h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">${date} ${time}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-size: 18px; font-weight: bold; margin: 0; color: ${
                                      inv.totals.balance > 0
                                        ? "#dc3545"
                                        : "#28a745"
                                    };">
                                        ‚Çπ${inv.totals.grandTotal.toFixed(2)}
                                    </p>
                                    <p style="font-size: 13px; margin: 5px 0 0 0;">
                                        ${
                                          inv.totals.balance > 0
                                            ? "üî¥ ‡§¨‡§æ‡§ï‡•Ä: ‚Çπ" +
                                              inv.totals.balance.toFixed(2)
                                            : "‚úÖ ‡§™‡•Ç‡§∞‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®"
                                        }
                                    </p>
                                </div>
                            </div>

                            <div style="margin: 10px 0;">
                                <h5 style="margin: 0 0 8px 0; color: #667eea; font-size: 14px;">üì¶ ‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏:</h5>
                                ${itemsList}
                            </div>

                            <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; margin-top: 12px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                    <div>
                                        <p style="margin: 3px 0;"><strong>‡§ß‡§æ‡§§‡•Å ‡§Æ‡•Ç‡§≤‡•ç‡§Ø:</strong> ‚Çπ${inv.totals.metalValue.toFixed(
                                          2
                                        )}</p>
                                        <p style="margin: 3px 0;"><strong>‡§Æ‡§ú‡§¶‡•Ç‡§∞‡•Ä:</strong> ‚Çπ${inv.totals.labour.toFixed(
                                          2
                                        )}</p>
                                        ${
                                          inv.oldJewellery
                                            ? `<p style="margin: 3px 0;"><strong>‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å:</strong> ‚Çπ${inv.oldJewellery.amount.toFixed(
                                                2
                                              )}</p>
                                              ${inv.oldJewellery.calculation && (inv.oldJewellery.calculation.weight > 0 || inv.oldJewellery.calculation.tounch > 0 || inv.oldJewellery.calculation.rate10g > 0)
                                                ? `<p style="margin: 3px 0; font-size: 12px; color: #666;">
                                                    (‡§µ‡§ú‡§®: ${inv.oldJewellery.calculation.weight}g, 
                                                    ‡§ü‡§ö: ${inv.oldJewellery.calculation.tounch}, 
                                                    ‡§≠‡§æ‡§µ: ‚Çπ${inv.oldJewellery.calculation.rate10g}/10g)
                                                  </p>`
                                                : ""
                                              }`
                                            : ""
                                        }
                                        ${
                                          inv.totals.finalDiscount > 0
                                            ? `<p style="margin: 3px 0; color: #28a745;"><strong>‡§õ‡•Ç‡§ü:</strong> -‚Çπ${inv.totals.finalDiscount.toFixed(
                                                2
                                              )}</p>`
                                            : ""
                                        }
                                    </div>
                                    <div>
                                        <p style="margin: 3px 0;"><strong>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${inv.totals.grandTotal.toFixed(
                                          2
                                        )}</p>
                                        ${
                                          inv.totals.finalDiscount > 0
                                            ? `<p style="margin: 3px 0;"><strong>‡§õ‡•Ç‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶:</strong> ‚Çπ${inv.totals.discountedTotal.toFixed(
                                                2
                                              )}</p>`
                                            : ""
                                        }
                                        <p style="margin: 3px 0;"><strong>‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§:</strong> ‚Çπ${inv.payment.received.toFixed(
                                          2
                                        )}</p>
                                        <p style="margin: 3px 0; color: ${
                                          inv.totals.balance > 0
                                            ? "red"
                                            : "green"
                                        }; font-weight: bold;"><strong>‡§¨‡§æ‡§ï‡•Ä:</strong> ‚Çπ${inv.totals.balance.toFixed(
              2
            )}</p>
                                    </div>
                                </div>
                                ${
                                  inv.oldJewellery &&
                                  inv.oldJewellery.description
                                    ? `<p style="margin: 8px 0 0 0; font-size: 12px; color: #666;"><em>‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ß‡§æ‡§§‡•Å: ${inv.oldJewellery.description}</em></p>`
                                    : ""
                                }
                            </div>
                        </div>
                    `;
          });
        } else {
          invoicesHTML =
            '<p style="text-align: center; color: #666; margin-top: 20px;">‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§¨‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>';
        }

        const detailContent = document.getElementById("customerDetailContent");
        detailContent.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin: 15px 0; color: white;">
                    <h3 style="margin: 0 0 10px 0; font-size: 18px;">${
                      customer.name
                    }</h3>
                    <p style="margin: 5px 0; opacity: 0.9; font-size: 14px;">üìû ${
                      customer.phone
                    }</p>
                    <p style="margin: 5px 0; opacity: 0.9; font-size: 14px;">üìÑ ‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§≤: ${
                      customerInvoices.length
                    }</p>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <p style="margin: 5px 0; opacity: 0.9; font-size: 13px;">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•Ä‡§¶</p>
                        <p style="font-size: 22px; font-weight: bold; margin: 5px 0;">‚Çπ${customer.totalPurchase.toFixed(
                          2
                        )}</p>
                        <p style="font-size: 16px; margin: 10px 0; ${
                          customer.balance > 0
                            ? "background: #fff; color: #dc3545; padding: 8px; border-radius: 5px;"
                            : ""
                        }">
                            ${
                              customer.balance > 0
                                ? "‚ö†Ô∏è ‡§¨‡§æ‡§ï‡•Ä: ‚Çπ" + customer.balance.toFixed(2)
                                : customer.balance < 0
                                ? "‚úÖ ‡§∞‡§æ‡§∂‡§ø ‡§ú‡§Æ‡§æ ‡§π‡•à: ‚Çπ" +
                                  Math.abs(customer.balance).toFixed(2)
                                : "‚úÖ ‡§ï‡•ã‡§à ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç"
                            }
                        </p>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 20px 0 15px 0; font-size: 17px;">üìã ‡§∏‡§≠‡•Ä ‡§¨‡§ø‡§≤ (${
                  customerInvoices.length
                })</h3>
                ${invoicesHTML}
            `;

        document.getElementById("customerListView").style.display = "none";
        document.getElementById("customerDetailView").style.display = "block";
      }

      function closeCustomerDetail() {
        document.getElementById("customerDetailView").style.display = "none";
        document.getElementById("customerListView").style.display = "block";
      }

      // Interest Business
      function addInterestTransaction() {
        const type = document.getElementById("transactionType").value;
        const name = document.getElementById("transactionName").value.trim();
        const amount =
          parseFloat(document.getElementById("transactionAmount").value) || 0;
        const rate =
          parseFloat(document.getElementById("interestRate").value) || 0;
        const date = document.getElementById("transactionDate").value;

        if (!name || amount <= 0 || rate <= 0 || !date) {
          alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç! (Please fill all information!)");
          return;
        }

        appData.interestTransactions.push({
          id: Date.now(),
          type,
          name,
          amount,
          rate,
          date,
          active: true,
          interestPayments: [], // Track interest payments
          totalInterestPaid: 0,
        });

        saveData();
        renderInterestTransactions();
        updateInterestStats();

        // Clear form
        document.getElementById("transactionName").value = "";
        document.getElementById("transactionAmount").value = "";
        document.getElementById("interestRate").value = "";
        document.getElementById("transactionDate").value = "";

        alert("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ! (Transaction added!)");
      }

      function renderInterestTransactions() {
        const tbody = document.getElementById("interestBody");
        if (!tbody) {
          console.error("Interest body element not found");
          return;
        }
        tbody.innerHTML = "";

        const activeTransactions = appData.interestTransactions.filter(
          (t) => t.active
        );

        if (activeTransactions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" style="text-align: center; padding: 20px;">‡§ï‡•ã‡§à ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>';
        } else {
          activeTransactions.forEach((trans) => {
            // Initialize tracking fields if they don't exist (for old data)
            if (!trans.interestPayments) trans.interestPayments = [];
            if (trans.totalInterestPaid === undefined)
              trans.totalInterestPaid = 0;

            const monthsElapsed = calculateMonths(
              new Date(trans.date),
              new Date()
            );
            const totalInterest = calculateTotalInterest(trans);
            const pendingInterest = totalInterest - trans.totalInterestPaid;
            const paidPrincipal = trans.totalPrincipalPaid || 0;
            const pendingPrincipal = trans.amount - paidPrincipal;

            const row = tbody.insertRow();
            row.innerHTML = `
                        <td><strong>${trans.name}</strong></td>
                        <td>${
                          trans.type === "lent"
                            ? "üì§ ‡§¶‡§ø‡§Ø‡§æ"
                            : trans.type === "borrowed"
                            ? "üì• ‡§≤‡§ø‡§Ø‡§æ"
                            : "üìø ‡§ó‡§π‡§®‡§æ"
                        }</td>
                        <td>‚Çπ${trans.amount.toFixed(2)}</td>
                        <td>${trans.rate}%</td>
                        <td>${new Date(trans.date).toLocaleDateString(
                          "hi-IN"
                        )}<br><small>${monthsElapsed} ‡§Æ‡§π‡•Ä‡§®‡•á</small></td>
                        <td>‚Çπ${totalInterest.toFixed(2)}</td>
                        <td style="color: green; font-weight: bold;">‚Çπ${trans.totalInterestPaid.toFixed(
                          2
                        )}</td>
                        <td style="color: ${
                          pendingInterest > 0 ? "red" : "green"
                        }; font-weight: bold;">‚Çπ${pendingInterest.toFixed(
              2
            )}</td>
                        <td style="color: green; font-weight: bold;">‚Çπ${paidPrincipal.toFixed(
                          2
                        )}</td>
                        <td style="color: ${
                          pendingPrincipal > 0 ? "red" : "green"
                        }; font-weight: bold;">‚Çπ${pendingPrincipal.toFixed(
              2
            )}</td>
                        <td>
                            <div class="action-buttons" style="display: flex; flex-direction: column; gap: 5px;">
                                <button class="btn-edit" style="font-size: 12px; padding: 8px;" onclick="payInterest(${
                                  trans.id
                                })">‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ú‡§Æ‡§æ</button>
                                <button class="btn" style="font-size: 12px; padding: 8px; background: #17a2b8;" onclick="payPrincipal(${
                                  trans.id
                                })">‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§ú‡§Æ‡§æ</button>
                                <button class="btn-view" style="font-size: 12px; padding: 8px;" onclick="viewInterestHistory(${
                                  trans.id
                                })">‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                                <button class="btn" style="font-size: 12px; padding: 8px; background: #28a745;" onclick="squareOff(${
                                  trans.id
                                })">‡§∏‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞ ‡§ë‡§´</button>
                            </div>
                        </td>
                    `;
          });
        }

        updateInterestStats();
        renderClosedTransactions();
      }

      function renderClosedTransactions() {
        const tbody = document.getElementById("closedInterestBody");
        if (!tbody) {
          console.log("closedInterestBody element not found yet");
          return;
        }
        tbody.innerHTML = "";

        const closedTransactions = appData.interestTransactions.filter(
          (t) => !t.active
        );

        if (closedTransactions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="8" style="text-align: center; padding: 20px;">‡§ï‡•ã‡§à ‡§¨‡§Ç‡§¶ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</td></tr>';
        } else {
          closedTransactions.forEach((trans) => {
            const startDate = new Date(trans.date);
            const endDate = trans.closedDate
              ? new Date(trans.closedDate)
              : new Date();
            const monthsElapsed = calculateMonths(startDate, endDate);
            const totalInterest = calculateTotalInterest(trans);

            const row = tbody.insertRow();
            row.innerHTML = `
                        <td><strong>${trans.name}</strong></td>
                        <td>${
                          trans.type === "lent" ? "üì§ ‡§¶‡§ø‡§Ø‡§æ" : "üì• ‡§≤‡§ø‡§Ø‡§æ"
                        }</td>
                        <td>‚Çπ${trans.amount.toFixed(2)}</td>
                        <td>${trans.rate}%</td>
                        <td>${startDate.toLocaleDateString("hi-IN")}</td>
                        <td>${endDate.toLocaleDateString(
                          "hi-IN"
                        )}<br><small>${monthsElapsed} ‡§Æ‡§π‡•Ä‡§®‡•á</small></td>
                        <td>‚Çπ${totalInterest.toFixed(2)}<br><small>‡§ú‡§Æ‡§æ: ‚Çπ${
              trans.totalInterestPaid
                ? trans.totalInterestPaid.toFixed(2)
                : "0.00"
            }</small></td>
                        <td>
                            <button class="btn-view" style="font-size: 12px; padding: 8px;" onclick="viewInterestHistory(${
                              trans.id
                            })">‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
                        </td>
                    `;
          });
        }
      }

      function toggleClosedTransactions() {
        const view = document.getElementById("closedTransactionsView");
        if (view.style.display === "none") {
          view.style.display = "block";
        } else {
          view.style.display = "none";
        }
      }

      function calculateMonths(startDate, endDate) {
        const months =
          (endDate.getFullYear() - startDate.getFullYear()) * 12 +
          (endDate.getMonth() - startDate.getMonth());
        return Math.max(0, months);
      }

      // Calculate interest considering principal payments
      function calculateTotalInterest(trans, endDate = null) {
        if (!endDate)
          endDate = trans.active
            ? new Date()
            : trans.closedDate
            ? new Date(trans.closedDate)
            : new Date();

        const startDate = new Date(trans.date);

        // If no principal payments, simple calculation
        if (!trans.principalPayments || trans.principalPayments.length === 0) {
          const monthsElapsed = calculateMonths(startDate, endDate);
          return (trans.amount * trans.rate * monthsElapsed) / 100;
        }

        // Calculate interest with principal adjustments
        let totalInterest = 0;
        let currentPrincipal = trans.amount;
        let lastDate = startDate;

        // Sort principal payments by date
        const sortedPayments = [...trans.principalPayments].sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );

        sortedPayments.forEach((payment) => {
          const paymentDate = new Date(payment.date);
          if (paymentDate > endDate) return; // Don't count future payments

          // Calculate interest for period before this payment
          const months = calculateMonths(lastDate, paymentDate);
          totalInterest += (currentPrincipal * trans.rate * months) / 100;

          // Reduce principal
          currentPrincipal -= payment.amount;
          lastDate = paymentDate;
        });

        // Calculate remaining interest from last payment to end date
        const remainingMonths = calculateMonths(lastDate, endDate);
        totalInterest +=
          (currentPrincipal * trans.rate * remainingMonths) / 100;

        return totalInterest;
      }

      // Modal Management
      let currentTransactionId = null;
      let currentPaymentType = "interest"; // 'interest' or 'principal'
      let isSquareOff = false;

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        if (modalId === "payInterestModal") {
          document.getElementById("payInterestAmount").value = "";
        }
        currentTransactionId = null;
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };

      function payInterest(id) {
        console.log("payInterest called with id:", id);
        currentPaymentType = "interest";
        const trans = appData.interestTransactions.find((t) => t.id === id);
        if (!trans) {
          showNotification("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!", "error");
          return;
        }

        currentTransactionId = id;

        const monthsElapsed = calculateMonths(new Date(trans.date), new Date());
        const totalInterest = calculateTotalInterest(trans);
        const pendingInterest = totalInterest - trans.totalInterestPaid;

        if (pendingInterest <= 0) {
          showNotification("‡§ï‡•ã‡§à ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¨‡§æ‡§ï‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!", "success");
          return;
        }

        const content = document.getElementById("payInterestContent");
        content.innerHTML = `
                <div class="info-box">
                    <h4 style="margin: 0 0 10px 0; color: #2196F3;">üìã ${
                      trans.name
                    }</h4>
                    <p style="margin: 5px 0;"><strong>‡§Æ‡•Ç‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${trans.amount.toFixed(
                      2
                    )}</p>
                    <p style="margin: 5px 0;"><strong>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞:</strong> ${
                      trans.rate
                    }% ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π</p>
                    <p style="margin: 5px 0;"><strong>‡§∏‡§Æ‡§Ø:</strong> ${monthsElapsed} ‡§Æ‡§π‡•Ä‡§®‡•á</p>
                </div>
                <div class="stat-grid-modal">
                    <div class="stat-box" style="background: #e7f3ff; color: #2196F3;">
                        <p>‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú</p>
                        <p>‚Çπ${totalInterest.toFixed(2)}</p>
                    </div>
                    <div class="stat-box" style="background: #d4edda; color: #28a745;">
                        <p>‡§ú‡§Æ‡§æ</p>
                        <p>‚Çπ${trans.totalInterestPaid.toFixed(2)}</p>
                    </div>
                    <div class="stat-box" style="background: #f8d7da; color: #dc3545;">
                        <p>‡§¨‡§æ‡§ï‡•Ä</p>
                        <p>‚Çπ${pendingInterest.toFixed(2)}</p>
                    </div>
                </div>
            `;

        // Update input field properties
        const inputField = document.getElementById("payInterestAmount");
        inputField.max = pendingInterest.toFixed(2);
        inputField.value = "";

        // Update label
        document.getElementById("paymentInputLabel").textContent =
          "‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∞‡§æ‡§∂‡§ø (‚Çπ)";
        document
          .getElementById("payInterestModal")
          .querySelector(".modal-header h3").textContent = "üí∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç";
        openModal("payInterestModal");
      }

      function confirmPayInterest() {
        if (currentPaymentType === "principal") {
          confirmPayPrincipal();
          return;
        }

        const amount = parseFloat(
          document.getElementById("payInterestAmount").value
        );

        if (!amount || amount <= 0) {
          showNotification("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!", "error");
          return;
        }

        const trans = appData.interestTransactions.find(
          (t) => t.id === currentTransactionId
        );
        if (!trans) return;

        const monthsElapsed = calculateMonths(new Date(trans.date), new Date());
        const totalInterest = calculateTotalInterest(trans);
        const pendingInterest = totalInterest - trans.totalInterestPaid;

        if (amount > pendingInterest) {
          showNotification("‡§∞‡§æ‡§∂‡§ø ‡§¨‡§æ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä!", "error");
          return;
        }

        trans.interestPayments.push({
          date: new Date().toISOString(),
          amount: amount,
        });
        trans.totalInterestPaid += amount;

        saveData();
        renderInterestTransactions();
        closeModal("payInterestModal");
        showNotification(
          `‚úì ‚Çπ${amount.toFixed(2)} ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ú‡§Æ‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ!`,
          "success"
        );
      }

      function viewInterestHistory(id) {
        console.log("viewInterestHistory called with id:", id);
        const trans = appData.interestTransactions.find((t) => t.id === id);
        if (!trans) {
          showNotification("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!", "error");
          return;
        }

        const startDate = new Date(trans.date);
        const endDate = trans.active
          ? new Date()
          : trans.closedDate
          ? new Date(trans.closedDate)
          : new Date();
        const monthsElapsed = calculateMonths(startDate, endDate);
        const totalInterest = calculateTotalInterest(trans);
        const pendingInterest = totalInterest - (trans.totalInterestPaid || 0);

        let statusBadge = "";
        if (!trans.active) {
          statusBadge = `<div style="background: #6c757d; color: white; padding: 8px; border-radius: 5px; text-align: center; margin-bottom: 10px; font-weight: bold;">‚úì ‡§¨‡§Ç‡§¶ (${new Date(
            trans.closedDate
          ).toLocaleDateString("hi-IN")})</div>`;
        }

        let paymentsHTML = "";

        // Combine both interest and principal payments with chronological sorting
        const allPayments = [];

        if (trans.interestPayments && trans.interestPayments.length > 0) {
          trans.interestPayments.forEach((payment, index) => {
            allPayments.push({
              type: "interest",
              date: payment.date,
              amount: payment.amount,
            });
          });
        }

        if (trans.principalPayments && trans.principalPayments.length > 0) {
          trans.principalPayments.forEach((payment, index) => {
            allPayments.push({
              type: "principal",
              date: payment.date,
              amount: payment.amount,
            });
          });
        }

        if (allPayments.length > 0) {
          // Sort by date - latest first
          allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

          paymentsHTML = `
                    <h4 style="color: #667eea; margin: 15px 0 10px 0; font-size: 16px;">üí∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h4>
                    <div style="max-height: 250px; overflow-y: auto;">
                `;
          allPayments.forEach((payment, index) => {
            const typeLabel = payment.type === "interest" ? "‡§¨‡•ç‡§Ø‡§æ‡§ú" : "‡§Æ‡•Ç‡§≤‡§ß‡§®";
            const typeColor =
              payment.type === "interest" ? "#28a745" : "#17a2b8";
            const typeIcon = payment.type === "interest" ? "üìä" : "üí∞";

            paymentsHTML += `
                        <div style="background: #f8f9fa; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid ${typeColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <p style="margin: 0; font-weight: bold; font-size: 14px;">${typeIcon} ${typeLabel} ‡§≠‡•Å‡§ó‡§§‡§æ‡§®</p>
                                    <p style="margin: 3px 0 0 0; font-size: 12px; color: #666;">${new Date(
                                      payment.date
                                    ).toLocaleDateString("hi-IN")}</p>
                                </div>
                                <p style="margin: 0; font-size: 18px; font-weight: bold; color: ${typeColor};">‚Çπ${payment.amount.toFixed(
              2
            )}</p>
                            </div>
                        </div>
                    `;
          });
          paymentsHTML += `</div>`;
        } else {
          paymentsHTML = `
                    <div class="warning-box" style="margin-top: 15px;">
                        <p style="margin: 0; font-size: 14px;">‚ö†Ô∏è ‡§ï‡•ã‡§à ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§</p>
                    </div>
                `;
        }

        const content = document.getElementById("interestHistoryContent");
        content.innerHTML = `
                ${statusBadge}
                <div class="info-box">
                    <h4 style="margin: 0 0 10px 0; color: #2196F3; font-size: 16px;">üìä ${
                      trans.name
                    }</h4>
                    <div style="font-size: 13px;">
                        <p style="margin: 5px 0;"><strong>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:</strong> ${
                          trans.type === "lent"
                            ? "üì§ ‡§â‡§ß‡§æ‡§∞ ‡§¶‡§ø‡§Ø‡§æ"
                            : trans.type === "borrowed"
                            ? "üì• ‡§â‡§ß‡§æ‡§∞ ‡§≤‡§ø‡§Ø‡§æ"
                            : "üìø ‡§ó‡§π‡§®‡§æ"
                        }</p>
                        <p style="margin: 5px 0;"><strong>‡§Æ‡•Ç‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${trans.amount.toFixed(
                          2
                        )}</p>
                        <p style="margin: 5px 0;"><strong>‡§ö‡•Å‡§ï‡§æ‡§Ø‡§æ ‡§Æ‡•Ç‡§≤‡§ß‡§®:</strong> ‚Çπ${(
                          trans.totalPrincipalPaid || 0
                        ).toFixed(2)}</p>
                        <p style="margin: 5px 0;"><strong>‡§¨‡§æ‡§ï‡•Ä ‡§Æ‡•Ç‡§≤‡§ß‡§®:</strong> ‚Çπ${(
                          trans.amount - (trans.totalPrincipalPaid || 0)
                        ).toFixed(2)}</p>
                        <p style="margin: 5px 0;"><strong>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞:</strong> ${
                          trans.rate
                        }% ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π</p>
                        <p style="margin: 5px 0;"><strong>‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§:</strong> ${startDate.toLocaleDateString(
                          "hi-IN"
                        )}</p>
                        ${
                          !trans.active
                            ? `<p style="margin: 5px 0;"><strong>‡§¨‡§Ç‡§¶:</strong> ${endDate.toLocaleDateString(
                                "hi-IN"
                              )}</p>`
                            : ""
                        }
                        <p style="margin: 5px 0;"><strong>‡§ï‡•Å‡§≤ ‡§∏‡§Æ‡§Ø:</strong> ${monthsElapsed} ‡§Æ‡§π‡•Ä‡§®‡•á</p>
                        <p style="margin: 5px 0;"><strong>‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®:</strong> ${
                          (trans.interestPayments
                            ? trans.interestPayments.length
                            : 0) +
                          (trans.principalPayments
                            ? trans.principalPayments.length
                            : 0)
                        } ‡§¨‡§æ‡§∞</p>
                    </div>
                </div>

                <div class="stat-grid-modal">
                    <div class="stat-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <p>‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú</p>
                        <p>‚Çπ${totalInterest.toFixed(2)}</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                        <p>‡§ú‡§Æ‡§æ ‡§¨‡•ç‡§Ø‡§æ‡§ú</p>
                        <p>‚Çπ${(trans.totalInterestPaid || 0).toFixed(2)}</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white;">
                        <p>‡§¨‡§æ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú</p>
                        <p>‚Çπ${pendingInterest.toFixed(2)}</p>
                    </div>
                </div>

                ${paymentsHTML}
            `;

        openModal("interestHistoryModal");
      }

      function closeTransaction(id) {
        console.log("closeTransaction called with id:", id);
        isSquareOff = false;
        const trans = appData.interestTransactions.find((t) => t.id === id);
        if (!trans) {
          showNotification("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!", "error");
          return;
        }

        currentTransactionId = id;

        const monthsElapsed = calculateMonths(new Date(trans.date), new Date());
        const totalInterest = calculateTotalInterest(trans);
        const pendingInterest = totalInterest - trans.totalInterestPaid;

        let warningHTML = "";
        if (pendingInterest > 0) {
          warningHTML = `
                    <div class="warning-box">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä!</h4>
                        <p style="margin: 5px 0; font-size: 18px;"><strong>‚Çπ${pendingInterest.toFixed(
                          2
                        )} ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¨‡§æ‡§ï‡•Ä ‡§π‡•à!</strong></p>
                        <p style="margin: 10px 0; color: #856404;">‡§Ö‡§ó‡§∞ ‡§Ü‡§™ ‡§Ö‡§≠‡•Ä ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§§‡•ã ‡§¨‡§æ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§Æ‡§æ‡§´ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§</p>
                    </div>
                `;
        } else {
          warningHTML = `
                    <div class="success-box">
                        <h4 style="margin: 0 0 10px 0; color: #155724;">‚úì ‡§∏‡§≠‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ö‡•Å‡§ï‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à</h4>
                        <p style="margin: 0;">‡§Ü‡§™ ‡§á‡§∏ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•ã ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡§Ç‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
                    </div>
                `;
        }

        const content = document.getElementById("closeTransactionContent");
        content.innerHTML = `
                <div class="info-box">
                    <h4 style="margin: 0 0 10px 0; color: #2196F3; font-size: 16px;">üìã ${
                      trans.name
                    }</h4>
                    <div style="font-size: 13px;">
                        <p style="margin: 5px 0;"><strong>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:</strong> ${
                          trans.type === "lent"
                            ? "üì§ ‡§â‡§ß‡§æ‡§∞ ‡§¶‡§ø‡§Ø‡§æ"
                            : "üì• ‡§â‡§ß‡§æ‡§∞ ‡§≤‡§ø‡§Ø‡§æ"
                        }</p>
                        <p style="margin: 5px 0;"><strong>‡§Æ‡•Ç‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${trans.amount.toFixed(
                          2
                        )}</p>
                        <p style="margin: 5px 0;"><strong>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞:</strong> ${
                          trans.rate
                        }%</p>
                        <p style="margin: 5px 0;"><strong>‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú:</strong> ‚Çπ${totalInterest.toFixed(
                          2
                        )}</p>
                        <p style="margin: 5px 0;"><strong>‡§ú‡§Æ‡§æ ‡§¨‡•ç‡§Ø‡§æ‡§ú:</strong> ‚Çπ${trans.totalInterestPaid.toFixed(
                          2
                        )}</p>
                        <p style="margin: 5px 0; color: ${
                          pendingInterest > 0 ? "#dc3545" : "#28a745"
                        }; font-weight: bold;"><strong>‡§¨‡§æ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú:</strong> ‚Çπ${pendingInterest.toFixed(
          2
        )}</p>
                    </div>
                </div>

                ${warningHTML}

                <p style="margin: 15px 0; text-align: center; font-size: 15px; font-weight: bold;">‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•ã ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
            `;

        openModal("closeTransactionModal");
      }

      function confirmCloseTransaction() {
        if (isSquareOff) {
          confirmSquareOff();
          return;
        }

        const trans = appData.interestTransactions.find(
          (t) => t.id === currentTransactionId
        );
        if (!trans) return;

        trans.active = false;
        trans.closedDate = new Date().toISOString();
        saveData();
        renderInterestTransactions();
        closeModal("closeTransactionModal");
        showNotification("‚úì ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§¨‡§Ç‡§¶ ‡§π‡•ã ‡§ó‡§Ø‡§æ!", "success");
      }

      // Pay Principal
      function payPrincipal(id) {
        currentPaymentType = "principal";
        const trans = appData.interestTransactions.find((t) => t.id === id);
        if (!trans) {
          showNotification("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!", "error");
          return;
        }

        if (!trans.principalPayments) trans.principalPayments = [];
        if (trans.totalPrincipalPaid === undefined)
          trans.totalPrincipalPaid = 0;

        const remainingPrincipal = trans.amount - trans.totalPrincipalPaid;

        if (remainingPrincipal <= 0) {
          showNotification("‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§™‡•Ç‡§∞‡§æ ‡§ö‡•Å‡§ï‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à!", "success");
          return;
        }

        currentTransactionId = id;

        const content = document.getElementById("payInterestContent");
        content.innerHTML = `
                <div class="info-box">
                    <h4 style="margin: 0 0 10px 0; color: #17a2b8;">üí∞ ${
                      trans.name
                    } - ‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§ú‡§Æ‡§æ</h4>
                    <p style="margin: 5px 0;"><strong>‡§Æ‡•Ç‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${trans.amount.toFixed(
                      2
                    )}</p>
                    <p style="margin: 5px 0;"><strong>‡§ö‡•Å‡§ï‡§æ‡§Ø‡§æ:</strong> ‚Çπ${trans.totalPrincipalPaid.toFixed(
                      2
                    )}</p>
                    <p style="margin: 5px 0; color: #dc3545; font-weight: bold;"><strong>‡§¨‡§æ‡§ï‡•Ä:</strong> ‚Çπ${remainingPrincipal.toFixed(
                      2
                    )}</p>
                </div>
            `;

        // Update input field properties
        const inputField = document.getElementById("payInterestAmount");
        inputField.max = remainingPrincipal.toFixed(2);
        inputField.value = "";

        // Update label
        document.getElementById("paymentInputLabel").textContent =
          "‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§∞‡§æ‡§∂‡§ø (‚Çπ)";
        document
          .getElementById("payInterestModal")
          .querySelector(".modal-header h3").textContent = "üí∞ ‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç";
        openModal("payInterestModal");
      }

      function confirmPayPrincipal() {
        const amount = parseFloat(
          document.getElementById("payInterestAmount").value
        );
        const trans = appData.interestTransactions.find(
          (t) => t.id === currentTransactionId
        );
        if (!trans) return;

        if (!amount || amount <= 0) {
          showNotification("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!", "error");
          return;
        }

        const remainingPrincipal =
          trans.amount - (trans.totalPrincipalPaid || 0);
        if (amount > remainingPrincipal) {
          showNotification("‡§∞‡§æ‡§∂‡§ø ‡§¨‡§æ‡§ï‡•Ä ‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä!", "error");
          return;
        }

        if (!trans.principalPayments) trans.principalPayments = [];
        trans.principalPayments.push({
          date: new Date().toISOString(),
          amount: amount,
        });
        trans.totalPrincipalPaid = (trans.totalPrincipalPaid || 0) + amount;

        saveData();
        renderInterestTransactions();
        closeModal("payInterestModal");
        showNotification(
          `‚úì ‚Çπ${amount.toFixed(2)} ‡§Æ‡•Ç‡§≤‡§ß‡§® ‡§ú‡§Æ‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ!`,
          "success"
        );
      }

      // Square Off - Settle Everything
      function squareOff(id) {
        isSquareOff = true;
        const trans = appData.interestTransactions.find((t) => t.id === id);
        if (!trans) {
          showNotification("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!", "error");
          return;
        }

        const monthsElapsed = calculateMonths(new Date(trans.date), new Date());
        const totalInterest = calculateTotalInterest(trans);
        const pendingInterest = totalInterest - (trans.totalInterestPaid || 0);
        const pendingPrincipal = trans.amount - (trans.totalPrincipalPaid || 0);
        const totalPending = pendingInterest + pendingPrincipal;

        currentTransactionId = id;

        const content = document.getElementById("closeTransactionContent");
        content.innerHTML = `
                <div class="success-box">
                    <h4 style="margin: 0 0 10px 0; color: #28a745; font-size: 16px;">üí∞ ${
                      trans.name
                    } - ‡§∏‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞ ‡§ë‡§´</h4>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>‡§Æ‡•Ç‡§≤ ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${trans.amount.toFixed(
                      2
                    )}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>‡§¨‡§æ‡§ï‡•Ä ‡§Æ‡•Ç‡§≤‡§ß‡§®:</strong> ‚Çπ${pendingPrincipal.toFixed(
                      2
                    )}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>‡§ï‡•Å‡§≤ ‡§¨‡•ç‡§Ø‡§æ‡§ú:</strong> ‚Çπ${totalInterest.toFixed(
                      2
                    )}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>‡§¨‡§æ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú:</strong> ‚Çπ${pendingInterest.toFixed(
                      2
                    )}</p>
                    <hr style="margin: 10px 0;">
                    <p style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #dc3545;"><strong>‡§ï‡•Å‡§≤ ‡§¨‡§æ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø:</strong> ‚Çπ${totalPending.toFixed(
                      2
                    )}</p>
                </div>
                <p style="margin: 15px 0; text-align: center; font-size: 15px; font-weight: bold;">‡§∏‡§≠‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§ï‡•á ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç?</p>
            `;

        document
          .getElementById("closeTransactionModal")
          .querySelector(".modal-header h3").textContent = "üí∞ ‡§∏‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞ ‡§ë‡§´";
        openModal("closeTransactionModal");
      }

      function confirmSquareOff() {
        const trans = appData.interestTransactions.find(
          (t) => t.id === currentTransactionId
        );
        if (!trans) return;

        const monthsElapsed = calculateMonths(new Date(trans.date), new Date());
        const totalInterest = calculateTotalInterest(trans);
        const pendingInterest = totalInterest - (trans.totalInterestPaid || 0);
        const pendingPrincipal = trans.amount - (trans.totalPrincipalPaid || 0);

        // Pay all pending interest
        if (pendingInterest > 0) {
          if (!trans.interestPayments) trans.interestPayments = [];
          trans.interestPayments.push({
            date: new Date().toISOString(),
            amount: pendingInterest,
          });
          trans.totalInterestPaid = totalInterest;
        }

        // Pay all pending principal
        if (pendingPrincipal > 0) {
          if (!trans.principalPayments) trans.principalPayments = [];
          trans.principalPayments.push({
            date: new Date().toISOString(),
            amount: pendingPrincipal,
          });
          trans.totalPrincipalPaid = trans.amount;
        }

        // Close transaction
        trans.active = false;
        trans.closedDate = new Date().toISOString();

        saveData();
        renderInterestTransactions();
        closeModal("closeTransactionModal");
        showNotification("‚úì ‡§∏‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞ ‡§ë‡§´ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü! ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§¨‡§Ç‡§¶‡•§", "success");
      }

      // Notification System
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 20px 30px;
                background: ${
                  type === "success"
                    ? "#28a745"
                    : type === "error"
                    ? "#dc3545"
                    : "#2196F3"
                };
                color: white;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 16px;
                font-weight: bold;
                animation: slideInRight 0.3s;
            `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.3s";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Make functions globally accessible
      window.payInterest = payInterest;
      window.viewInterestHistory = viewInterestHistory;
      window.closeTransaction = closeTransaction;
      window.confirmPayInterest = confirmPayInterest;
      window.confirmCloseTransaction = confirmCloseTransaction;
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.toggleClosedTransactions = toggleClosedTransactions;
      window.payPrincipal = payPrincipal;
      window.squareOff = squareOff;
      window.fillPhoneFromName = fillPhoneFromName;
      window.searchCustomer = searchCustomer;

      function updateInterestStats() {
        let totalLent = 0;
        let totalBorrowed = 0;
        let monthlyProfit = 0;

        appData.interestTransactions
          .filter((t) => t.active)
          .forEach((trans) => {
            // Calculate current principal (after payments)
            const currentPrincipal =
              trans.amount - (trans.totalPrincipalPaid || 0);

            if (trans.type === "lent") {
              totalLent += currentPrincipal;
              monthlyProfit += (currentPrincipal * trans.rate) / 100;
            } else {
              totalBorrowed += currentPrincipal;
              monthlyProfit -= (currentPrincipal * trans.rate) / 100;
            }
          });

        document.getElementById("totalLent").textContent = totalLent.toFixed(0);
        document.getElementById("totalBorrowed").textContent =
          totalBorrowed.toFixed(0);
        document.getElementById("monthlyProfit").textContent =
          monthlyProfit.toFixed(0);
      }

      // Accounting
      function updateAccountingStats() {
        let totalSales = 0;
        let totalReceived = 0;

        appData.invoices.forEach((invoice) => {
          totalSales += invoice.totals.grandTotal;
          totalReceived += invoice.payment.received;
        });

        const totalPending = totalSales - totalReceived;

        document.getElementById("totalSales").textContent =
          totalSales.toFixed(0);
        document.getElementById("totalReceived").textContent =
          totalReceived.toFixed(0);
        document.getElementById("totalPending").textContent =
          totalPending.toFixed(0);
      }

      function generateReport() {
        const fromDate = new Date(
          document.getElementById("reportFromDate").value
        );
        const toDate = new Date(document.getElementById("reportToDate").value);

        if (
          !document.getElementById("reportFromDate").value ||
          !document.getElementById("reportToDate").value
        ) {
          alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç! (Please select dates!)");
          return;
        }

        const filteredInvoices = appData.invoices.filter((inv) => {
          const invDate = new Date(inv.date);
          return invDate >= fromDate && invDate <= toDate;
        });

        let totalSales = 0;
        let totalReceived = 0;

        filteredInvoices.forEach((inv) => {
          totalSales += inv.totals.grandTotal;
          totalReceived += inv.payment.received;
        });

        const resultDiv = document.getElementById("reportResult");
        resultDiv.innerHTML = `
                <div class="card">
                    <h3>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ (Report Results)</h3>
                    <p><strong>‡§Ö‡§µ‡§ß‡§ø:</strong> ${fromDate.toLocaleDateString(
                      "hi-IN"
                    )} ‡§∏‡•á ${toDate.toLocaleDateString("hi-IN")}</p>
                    <p><strong>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§≤:</strong> ${filteredInvoices.length}</p>
                    <p><strong>‡§ï‡•Å‡§≤ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä:</strong> ‚Çπ${totalSales.toFixed(
                      2
                    )}</p>
                    <p><strong>‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§:</strong> ‚Çπ${totalReceived.toFixed(
                      2
                    )}</p>
                    <p><strong>‡§¨‡§æ‡§ï‡•Ä:</strong> ‚Çπ${(
                      totalSales - totalReceived
                    ).toFixed(2)}</p>
                </div>
            `;
      }

      // Backup Functions
      function createBackup() {
        appData.lastBackup = new Date().toISOString();
        saveData();
        document.getElementById("lastBackup").textContent = new Date(
          appData.lastBackup
        ).toLocaleString("hi-IN");
        console.log(
          "‡§¨‡•à‡§ï‡§Ö‡§™ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ! (Backup created successfully!)"
        );
      }

      function downloadBackup() {
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `jewellery-backup-${
          new Date().toISOString().split("T")[0]
        }.json`;
        a.click();
        URL.revokeObjectURL(url);
        alert("‡§¨‡•à‡§ï‡§Ö‡§™ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ! (Backup downloaded!)");
      }

      function restoreBackup(input) {
        const file = input.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);
              if (
                confirm(
                  "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§°‡•á‡§ü‡§æ ‡§™‡•Å‡§®‡§∞‡•ç‡§∏‡•ç‡§•‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§ó‡§æ‡•§"
                )
              ) {
                appData = data;
                saveData();
                loadData();
                alert(
                  "‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•Å‡§®‡§∞‡•ç‡§∏‡•ç‡§•‡§æ‡§™‡§ø‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ! (Data restored successfully!)"
                );
              }
            } catch (error) {
              alert("‡§¨‡•à‡§ï‡§Ö‡§™ ‡§´‡§º‡§æ‡§á‡§≤ ‡§ó‡§≤‡§§ ‡§π‡•à! (Invalid backup file!)");
            }
          };
          reader.readAsText(file);
        }
      }

      function clearAllData() {
        if (
          confirm(
            "‚ö†Ô∏è ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä! ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä!"
          )
        ) {
          if (
            confirm(
              "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç? ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ!"
            )
          ) {
            localStorage.clear();
            location.reload();
          }
        }
      }

      // Initialize on page load
      window.onload = function () {
        loadData();
        document.getElementById("transactionDate").valueAsDate = new Date();

        // Set report dates to current month
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById("reportFromDate").valueAsDate = firstDay;
        document.getElementById("reportToDate").valueAsDate = today;

        // Listen for amount received changes
        document
          .getElementById("amountReceived")
          .addEventListener("input", updateInvoiceSummary);
        document
          .getElementById("oldJewelleryAmount")
          .addEventListener("input", updateInvoiceSummary);
      };
    </script>
  </body>
</html>
